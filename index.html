<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Solicita√ß√£o de Folga - DERSO</title>
<link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

<style>
:root {
    --azul-marinho: #0C3667;
    --dourado-amarelo: #FFD700;
    --azul-claro-hover: #1a5ca7;
    --erro: #b00020;
    --sucesso: #388e3c;
    --cinza-fundo: #f4f7f9;
    --cinza-texto: #333333;
    --borda-campo: #aaa;
}
body {
    background-color: var(--cinza-fundo);
    font-family: 'Roboto', Arial, sans-serif;
    color: var(--cinza-texto);
    margin: 0; padding: 0;
    display: flex; justify-content: center; align-items: center;
    min-height: 100vh;
}
body.modal-open { overflow: hidden; }

.container {
    width: 95%; max-width: 500px;
    background-color: #fff; border-radius: 8px; padding: 30px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.15); border:1px solid #ccc;
    box-sizing: border-box; display: flex; flex-direction: column; position: relative;
}

#progressBarContainer {
    position: absolute; top: 0; left: 0;
    width: 100%; height: 4px;
    background-color: #e0e0e0; border-radius: 8px 8px 0 0; overflow: hidden;
}
#progressBar {
    width: 0%; height: 100%;
    background-color: var(--dourado-amarelo); transition: width 0.4s ease;
}

.logos { display:flex; justify-content:center; align-items:center; gap:15px; margin-bottom:15px;}
.logos img { height:70px; object-fit:contain; }

h2 { font-family:'Merriweather', serif; text-align:center; color:var(--azul-marinho);
font-size:28px; font-weight:700; margin-bottom:10px;
border-bottom:2px solid var(--dourado-amarelo); padding-bottom:5px; }

.subtitle { text-align:center; font-size:16px; margin-bottom:25px; }

.institutional-highlight {
    text-align: center; font-size: 14px; color: var(--azul-marinho);
    font-weight: 500; font-style: italic;
    margin-bottom: 20px; padding: 12px;
    background-color: #fcfcfc; border: 1px solid #eee;
}

.info-message { display:none; text-align:center; font-weight:600; padding:15px; margin-bottom:20px; border-radius:4px; border-left:5px solid; transition: all 0.3s ease;}
.info-message.success { background-color:#e8f5e9; color:var(--sucesso); border-left-color:var(--sucesso);}
.info-message.error { background-color:#fce4ec; color:var(--erro); border-left-color:var(--erro);}
.info-message.loading { display:block; background-color:#eee; color:#666; border-left-color:#ccc;}

#successState { display:none; text-align:center; padding:20px; }
.check-icon { font-size:50px; color:var(--sucesso); margin-bottom:15px; }

.form-group, fieldset { margin-bottom:20px; width:100%; border:none; padding:0; }
label, legend { display:block; margin-bottom:8px; font-weight:500; }
.form-group input:not([type="radio"]), .form-group select { width:100%; padding:12px; border:1px solid var(--borda-campo); border-radius:4px; box-sizing:border-box; font-size:14px; }
.form-group input[readonly] { background-color:#f0f0f0; cursor:not-allowed; }
.is-valid { border-color:var(--sucesso) !important; box-shadow:0 0 0 2px rgba(56,142,60,0.1);}
.is-invalid { border-color:var(--erro) !important; box-shadow:0 0 0 2px rgba(176,0,32,0.1);}
#matriculaError { color:var(--erro); font-size:12px; margin-top:4px;}

.radio-group-buttons { display:flex; flex-wrap:wrap; gap:8px;}
.radio-group-buttons input { display:none; }
.radio-group-buttons label { padding:8px 12px; border:1px solid #ccc; border-radius:4px; cursor:pointer; font-size:13px; font-weight:600; transition:all 0.2s ease; user-select:none; }
.radio-group-buttons label:hover { background-color:#f4f4f4; }
.radio-group-buttons input:checked + label { background-color:var(--azul-marinho); color:var(--dourado-amarelo); border-color:var(--azul-marinho); }

.button { width:100%; padding:14px; border-radius:4px; border:none; cursor:pointer; background-color:var(--azul-claro-hover); color:#fff; font-size:16px; font-weight:700; text-transform:uppercase; transition: background-color 0.25s ease, transform 0.1s ease;}
.button:active { transform:scale(0.98);}
.button.secondary { background-color:#fff; color:var(--azul-marinho); border:1px solid var(--azul-marinho);}
.button:hover:not(:disabled) { background-color:var(--azul-marinho);}
.button.secondary:hover:not(:disabled) { background-color:var(--azul-marinho); color:var(--dourado-amarelo);}
.button:disabled { background-color:#ccc; color:#666; cursor:not-allowed; transform:none; }

.modal-base { position:fixed; inset:0; z-index:2000; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.6);}
.modal-content { background-color:#fff; border-radius:8px; padding:25px; width:90%; max-width:450px; max-height:80vh; overflow-y:auto; box-shadow:0 10px 40px rgba(0,0,0,0.2);}
#loadingOverlay { flex-direction:column; background: rgba(255,255,255,0.9); }
.spinner { width:30px; height:30px; margin:15px auto; border-radius:50%; border:4px solid rgba(0,0,0,0.1); border-top-color: var(--azul-claro-hover); animation: spin 1s linear infinite;}
@keyframes spin { 100%{ transform:rotate(360deg); } }
@keyframes blinker { 50% { opacity:0; } }

.footer { margin-top:20px; padding:8px 10px; text-align:center; font-size:10px; font-weight:400; font-style:italic; color:#666; border-top:1px solid #ddd;}
.texto-auxiliar { font-size:12px; color:#555; margin-top:8px;}
.estado-vazio { text-align:center; padding:20px 10px; font-size:13px; color:#777; font-style:italic; }
.hidden { display:none !important; }

@media (max-width:480px){ h1{ font-size:20px;} .card{padding:15px;} button{font-size:14px;} .footer{font-size:9px;} }
</style>
</head>
<body>

<div id="loadingOverlay" class="modal-base">
    <p style="color: var(--azul-marinho); font-weight:bold;">Carregando sistema...</p>
    <div class="spinner"></div>
</div>

<div id="historyModal" class="modal-base">
    <div class="modal-content">
        <h3 style="color:var(--azul-marinho); margin-top:0;">Hist√≥rico Recente</h3>
        <div id="historyBox"></div>
        <button type="button" class="button" id="closeHistory">Fechar</button>
    </div>
</div>

<div class="container">
    <div id="progressBarContainer"><div id="progressBar"></div></div>

    <div class="logos">
        <img src="https://rondonia.ro.gov.br/wp-content/uploads/2024/09/Brasao-PMRO-370x523.png" alt="PMRO">
        <img src="https://museu.pm.ro.gov.br/wp-content/uploads/2024/05/1-bpm-3.png" alt="1¬∫ BPM">
    </div>

    <h2>DERSO 1¬∫ BPM</h2>
    <p class="subtitle">Solicita√ß√£o de Di√°ria Especial de Refor√ßo do Servi√ßo Operacional - DERSO</p>

    <div id="instMessage" class="institutional-highlight"></div>
    <div id="prazoMessage" class="info-message loading">‚åõ Verificando prazos do sistema...</div>
    <div id="successState">
        <div class="check-icon">‚úì</div>
        <h3 style="color: var(--sucesso)">ENVIADO COM SUCESSO!</h3>
        <p>Sua solicita√ß√£o foi registrada no sistema.</p>
        <button class="button" onclick="closeSuccess()">Nova Solicita√ß√£o</button>
    </div>

    <form id="dersoForm" style="display:none;">
        <div class="form-group">
            <label for="email">E-mail:</label>
            <input type="email" id="email" name="email" required>
        </div>
        <div class="form-group">
            <label for="matricula">Matr√≠cula:</label>
            <input type="text" id="matricula" name="matricula" required placeholder="Ex: 12345">
            <div id="matriculaError"></div>
        </div>
        <div class="form-group">
            <label for="nome">Nome:</label>
            <input type="text" id="nome" name="nome" readonly required>
        </div>
        <fieldset>
            <legend>Tipo de Folga:</legend>
            <div class="radio-group-buttons">
                <input type="radio" id="folga24H" name="folga" value="24H"><label for="folga24H">24H</label>
                <input type="radio" id="folga48H" name="folga" value="48H"><label for="folga48H">48H</label>
                <input type="radio" id="folga72H" name="folga" value="72H"><label for="folga72H">72H</label>
                <input type="radio" id="folga96H" name="folga" value="96H"><label for="folga96H">96H</label>
                <input type="radio" id="folgaLE" name="folga" value="FOLGA LE"><label for="folgaLE">FOLGA LE</label>
                <input type="radio" id="folga1" name="folga" value="1¬™ Folga"><label for="folga1">1¬™ FOLGA</label>
                <input type="radio" id="folga2" name="folga" value="2¬™ Folga"><label for="folga2">2¬™ FOLGA</label>
                <input type="radio" id="folgaExp" name="folga" value="Expediente"><label for="folgaExp">EXPEDIENTE</label>
            </div>
        </fieldset>
        <div class="form-group">
            <label for="data">Data da Folga:</label>
            <input type="date" id="data" name="data" required>
        </div>
        <button type="button" class="button secondary" id="btnHistory">Minhas Solicita√ß√µes</button>
        <button type="submit" class="button" id="btnSubmit">Enviar Solicita√ß√£o</button>
    </form>

    <div class="footer"></div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby3FuQoK3JEZJl6zF2H1dTXNI4xAHgTKBk1g5oFhsR0LedGoVJP6xeipdJN2A9TJiv7wA/exec";
const matInput = document.getElementById("matricula");
const nomeInput = document.getElementById("nome");
const emailInput = document.getElementById("email");
const form = document.getElementById("dersoForm");
const progressBar = document.getElementById("progressBar");
const prazoMessage = document.getElementById("prazoMessage");
const instMessage = document.getElementById("instMessage");
const successDiv = document.getElementById("successState");
const historyModal = document.getElementById("historyModal");
let employeeList = {};

// Barra de progresso completa
function updateProgress() {
    const fields = [emailInput, matInput, nomeInput];
    let filled = 0;
    fields.forEach(f => { if(f.value.trim()!=='') filled++; });
    if(document.querySelector('input[name="folga"]:checked')) filled++;
    if(document.getElementById("data").value) filled++;
    const percent = (filled / 5) * 100;
    progressBar.style.width = percent + "%";
}

// Inicializa mensagens institucionais (igual HTML2)
function applyInstitutionalTheme() {
    const hoje = new Date();
    const mes = hoje.getMonth();
    const dia = hoje.getDate();
    const temasMensais = [
        "üé≠ Janeiro: Planejamento estrat√©gico.",
        "üéä Fevereiro: Foco e preven√ß√£o.",
        "üå∑ Mar√ßo: Homenagem √†s mulheres da Corpora√ß√£o.",
        "üïäÔ∏è Abril: Renova√ß√£o e uni√£o familiar.",
        "ü§± Maio: M√£es, a base de tudo.",
        "üî• Junho: Cultura e tradi√ß√µes.",
        "üëÆ Julho: Disciplina e prontid√£o.",
        "üëî Agosto: Presen√ßa familiar.",
        "üáßüá∑ Setembro: M√™s da P√°tria.",
        "üéóÔ∏è Outubro: Preven√ß√£o √© o melhor caminho.",
        "üìú Novembro: Compromisso republicano.",
        "üéÑ Dezembro: Planejamento e final de ano seguro."
    ];
    instMessage.innerText = temasMensais[mes];
}

// Valida√ß√£o matr√≠cula
function checkMatricula() {
    const val = matInput.value.trim();
    if(!val) { nomeInput.value=''; matInput.classList.remove('is-invalid','is-valid'); return;}
    const std = val.replace(/\D/g,'').padStart(5,'0');
    matInput.value = std;
    if(employeeList[std]) {
        nomeInput.value = employeeList[std];
        matInput.classList.add('is-valid'); matInput.classList.remove('is-invalid');
    } else {
        nomeInput.value=''; matInput.classList.add('is-invalid'); matInput.classList.remove('is-valid');
    }
}

// Submiss√£o do formul√°rio
form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const folga = document.querySelector('input[name="folga"]:checked');
    if(!folga) return alert("Selecione o tipo de folga.");
    const data = document.getElementById("data").value;
    const params = new URLSearchParams({
        email: emailInput.value,
        matricula: matInput.value,
        nome: nomeInput.value,
        folga: folga.value,
        data
    });
    try {
        const resp = await fetch(`${SCRIPT_URL}?${params.toString()}`);
        const result = await resp.json();
        if(result.error) return alert(`‚ùå ERRO: ${result.error}`);
        successDiv.style.display='block';
    } catch(err){
        alert("‚ùå Erro ao enviar solicita√ß√£o.");
    }
});

// Atualiza progresso em tempo real
document.querySelectorAll('#dersoForm input').forEach(i=>{
    i.addEventListener('input', updateProgress);
    i.addEventListener('blur', updateProgress);
});

// Fechar sucesso
function closeSuccess(){
    successDiv.style.display='none';
    document.getElementById("data").value='';
    document.querySelectorAll('input[name="folga"]').forEach(r=>r.checked=false);
    updateProgress();
}

// Hist√≥rico de solicita√ß√µes
document.getElementById("btnHistory").onclick = async ()=>{
    if(!matInput.value || matInput.classList.contains('is-invalid')) return alert("Insira uma matr√≠cula v√°lida.");
    historyModal.style.display='flex';
    document.getElementById("historyBox").innerHTML = "<div class='spinner'></div> Buscando...";
    try{
        const r = await fetch(`${SCRIPT_URL}?action=historico&matricula=${matInput.value}`);
        const d = await r.json();
        let h = `<div style="font-weight:bold; border-bottom:2px solid var(--dourado-amarelo);">${d.nome||'Solicitante'}</div>`;
        if(!d.historico || d.historico.length===0) h+="Nenhum registro.";
        else d.historico.forEach(i=>{ 
            const statusTexto = (i.status && i.status!=='PENDENTE') ? ` (${i.status})` : "";
            h+=`<div style="border-bottom:1px solid #eee;padding:8px 0;">${i.dataSolicitada} - ${i.tipoDeFolga}${statusTexto}</div>`;
        });
        document.getElementById("historyBox").innerHTML=h;
    }catch(e){ document.getElementById("historyBox").innerHTML="Erro ao carregar."; }
};

document.getElementById("closeHistory").onclick=()=>{ historyModal.style.display='none'; };

// Inicializa√ß√£o
window.addEventListener('DOMContentLoaded', ()=>{
    applyInstitutionalTheme();
    updateProgress();
    matInput.addEventListener('blur', checkMatricula);
});
</script>

</body>
</html>

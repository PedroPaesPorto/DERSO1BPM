<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Solicita√ß√£o de Folga - DERSO</title>
<link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root {
    --azul-marinho: #0C3667;
    --dourado-amarelo: #FFD700;
    --erro: #b00020;
    --sucesso: #388e3c;
    --cinza-fundo: #f4f7f9;
}
body {
    background: var(--cinza-fundo);
    font-family: 'Roboto', Arial, sans-serif;
    color:#333;
    display:flex;
    justify-content:center;
    padding:20px;
}
.container {
    background:#fff;
    border-radius:8px;
    padding:25px;
    width:100%;
    max-width:500px;
    box-shadow:0 5px 20px rgba(0,0,0,0.1);
    position:relative;
}
#progressBarContainer{ position:absolute; top:0; left:0; width:100%; height:4px; background:#e0e0e0; border-radius:8px 8px 0 0; overflow:hidden;}
#progressBar{ width:0%; height:100%; background:var(--dourado-amarelo); transition:0.4s;}

.institutional-highlight{
    text-align:center;
    font-size:14px;
    color:var(--azul-marinho);
    margin-bottom:15px;
    font-style:italic;
}
.info-message{ text-align:center; font-weight:600; margin-bottom:15px; }

input, select{
    width:100%;
    padding:10px;
    margin-bottom:12px;
    border:1px solid #aaa;
    border-radius:5px;
}
input.is-invalid{ border-color:var(--erro); }
input.is-valid{ border-color:var(--sucesso); }

button{
    width:100%;
    padding:12px;
    font-weight:bold;
    color:#fff;
    background:var(--azul-marinho);
    border:none;
    border-radius:5px;
    cursor:pointer;
}
button:disabled{ background:#888; cursor:not-allowed; }

.modal{ display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center;}
.modal-content{ background:#fff; padding:20px; border-radius:8px; max-width:400px; text-align:center;}
</style>
</head>
<body>

<div class="container">
    <div id="progressBarContainer"><div id="progressBar"></div></div>

    <h2>DERSO 1¬∫ BPM</h2>

    <!-- Se√ß√£o de temas institucionais -->
    <div id="instMessage" class="institutional-highlight"></div>

    <!-- Mensagem do cron√¥metro -->
    <div id="prazoMessage" class="info-message"></div>

    <!-- Formul√°rio -->
    <form id="dersoForm">
        <input type="email" id="email" name="email" placeholder="E-mail" required>
        <input type="text" id="matricula" name="matricula" placeholder="Matr√≠cula" required>
        <input type="text" id="nome" name="nome" placeholder="Nome" readonly required>

        <select name="folga" id="folga" required>
            <option value="">Selecione tipo de folga</option>
            <option value="Extra">Extra</option>
            <option value="Compensa√ß√£o">Compensa√ß√£o</option>
        </select>

        <input type="date" id="data" name="data" required>

        <button type="submit" id="btnSubmit">Enviar Solicita√ß√£o</button>
        <button type="button" id="btnHistory">Minhas Solicita√ß√µes</button>
    </form>
</div>

<!-- Modal de hist√≥rico -->
<div id="historyModal" class="modal">
    <div class="modal-content">
        <h3>Hist√≥rico</h3>
        <div id="historyBox"></div>
        <button onclick="document.getElementById('historyModal').style.display='none'">Fechar</button>
    </div>
</div>

<script>
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbyWAQ0esrOdpHEAHdcHwf6JszhlOIhBvdBQyuEnyeGx23hBjK4lisDfTijVRcvjUOnLvw/exec";

const matInput=document.getElementById("matricula");
const nomeInput=document.getElementById("nome");
const formDiv=document.getElementById("dersoForm");
const prazoMessageDiv=document.getElementById("prazoMessage");

// --- Temas institucionais ---
function applyInstitutionalTheme(){
    const hoje=new Date(), m=hoje.getMonth()+1, d=hoje.getDate();
    const inst=document.getElementById("instMessage");
    const temas={
        "1-4":"üå≥ Rond√¥nia: hist√≥ria e compromisso.",
        "5-1":"üõ†Ô∏è Dia do Trabalhador: servi√ßo p√∫blico em a√ß√£o.",
        "9-7":"üáßüá∑ 7 de Setembro: independ√™ncia e seguran√ßa.",
        "11-15":"üìú 15 de Novembro: fortalecendo a Rep√∫blica.",
        "11-20":"‚úä Consci√™ncia Negra: uni√£o e respeito.",
        "12-7":"üõ°Ô∏è 1¬∫ BPM: tradi√ß√£o e compromisso."
    };
    inst.textContent = temas[`${m}-${d}`] || "Bem-vindo ao sistema DERSO";
}

// --- Barra de progresso ---
function updateProgressBar(){
    const fields=document.querySelectorAll('#dersoForm [required]');
    let filled=0;
    fields.forEach(f=>{
        if(f.value.trim()!=="") filled++;
    });
    document.getElementById("progressBar").style.width=((filled/fields.length)*100)+"%";
}

// --- Cron√¥metro ---
function atualizarCronometro(abertura, fechamento){
    const agora=new Date();
    let msg="", classe="";

    if(agora<abertura){
        msg=`‚è≥ Formul√°rio abre em: ${Math.ceil((abertura-agora)/1000/60)} minutos`;
        classe="error"; formDiv.style.display="none";
    } else if(agora>fechamento){
        msg="‚õî Formul√°rio encerrado"; classe="error"; formDiv.style.display="none";
    } else {
        msg="üö® Formul√°rio aberto"; classe="success"; formDiv.style.display="block";
    }
    prazoMessageDiv.className="info-message "+classe;
    prazoMessageDiv.innerHTML=msg;
}

// --- Submiss√£o do formul√°rio ---
formDiv.addEventListener("submit",async e=>{
    e.preventDefault();
    const btn=document.getElementById("btnSubmit");
    btn.disabled=true;
    try{
        const params=new URLSearchParams(new FormData(formDiv));
        await fetch(SCRIPT_URL,{method:"POST",body:params});
        alert("‚úÖ Solicita√ß√£o enviada com sucesso!");
        document.getElementById("data").value=""; // limpa apenas o dia
    }catch(err){
        alert("‚ùå Erro de conex√£o");
    }finally{
        btn.disabled=false;
        updateProgressBar();
    }
});

// --- Hist√≥rico ---
document.getElementById("btnHistory").addEventListener("click",async ()=>{
    if(!matInput.value) return alert("Insira uma matr√≠cula v√°lida.");
    const modal=document.getElementById("historyModal");
    modal.style.display="flex";
    document.getElementById("historyBox").innerHTML="Carregando...";
    try{
        const r=await fetch(`${SCRIPT_URL}?action=historico&matricula=${matInput.value}`);
        const d=await r.json();
        let h="";
        if(!d.historico || d.historico.length===0) h="Nenhum registro.";
        else d.historico.forEach(i=>{ h+=`${i.dataSolicitada} - ${i.tipoDeFolga} (${i.status||'PENDENTE'})<br>`; });
        document.getElementById("historyBox").innerHTML=h;
    }catch{ document.getElementById("historyBox").innerHTML="Erro ao carregar"; }
});

// --- Inicializa√ß√£o ---
document.addEventListener("DOMContentLoaded",()=>{
    applyInstitutionalTheme();
    updateProgressBar();

    matInput.addEventListener("input",()=>{
        if(matInput.value.trim()!=="") matInput.classList.add("is-valid"); else matInput.classList.remove("is-valid");
    });

    // Carregar datas do GAS para cron√¥metro
    fetch(`${SCRIPT_URL}?action=datas`).then(r=>r.json()).then(data=>{
        const abertura=new Date(data.abertura);
        const fechamento=new Date(data.fechamento);
        setInterval(()=>atualizarCronometro(abertura,fechamento),1000);
    });

    // Atualizar barra de progresso ao digitar
    document.querySelectorAll('#dersoForm input, #dersoForm select').forEach(i=>{
        i.addEventListener('input',updateProgressBar);
    });
});
</script>
</body>
</html>

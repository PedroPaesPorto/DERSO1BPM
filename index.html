<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <!-- =====================================================
         METADADOS B√ÅSICOS DO DOCUMENTO
         ===================================================== -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Solicita√ß√£o de Folga - DERSO</title>

    <!-- =====================================================
         FONTES INSTITUCIONAIS
         Merriweather: t√≠tulos
         Roboto: corpo do texto
         ===================================================== -->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- =====================================================
         ESTILOS GERAIS DO SISTEMA
         Organiza√ß√£o por camadas:
         1. Vari√°veis
         2. Estrutura global
         3. Componentes
         4. Estados
         ===================================================== -->
    <style>

        /* =====================================================
           VARI√ÅVEIS DE TEMA INSTITUCIONAL
           Centralizam identidade visual
           ===================================================== */
        :root {
            --azul-marinho: #0C3667;
            --dourado-amarelo: #FFD700;
            --azul-claro-hover: #1a5ca7;

            --erro: #b00020;
            --sucesso: #388e3c;

            --cinza-fundo: #f4f7f9;
            --cinza-texto: #333333;
            --borda-campo: #aaa;
        }

        /* =====================================================
           RESET FUNCIONAL E BODY
           ===================================================== */
        body {
            background-color: var(--cinza-fundo);
            font-family: 'Roboto', Arial, sans-serif;
            color: var(--cinza-texto);

            margin: 0;
            padding: 0;

            display: flex;
            justify-content: center;
            align-items: center;

            min-height: 100vh;
        }

        /* Bloqueia rolagem quando modal estiver aberto */
        body.modal-open {
            overflow: hidden;
        }

        /* =====================================================
           CONTAINER PRINCIPAL
           ===================================================== */
        .container {
            width: 95%;
            max-width: 500px;

            background-color: #ffffff;
            border-radius: 8px;
            padding: 30px;

            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            border: 1px solid #ccc;

            box-sizing: border-box;

            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* =====================================================
           BARRA DE PROGRESSO SUPERIOR
           ===================================================== */
        #progressBarContainer {
            position: absolute;
            top: 0;
            left: 0;

            width: 100%;
            height: 4px;

            background-color: #e0e0e0;
            border-radius: 8px 8px 0 0;
            overflow: hidden;
        }

        #progressBar {
            width: 0%;
            height: 100%;
            background-color: var(--dourado-amarelo);
            transition: width 0.4s ease;
        }

        /* =====================================================
           LOGOTIPOS E T√çTULOS
           ===================================================== */
        .logos {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .logos img {
            height: 70px;
            object-fit: contain;
        }

        h2 {
            font-family: 'Merriweather', serif;
            text-align: center;
            color: var(--azul-marinho);

            font-size: 28px;
            font-weight: 700;

            margin-bottom: 10px;
            border-bottom: 2px solid var(--dourado-amarelo);
            padding-bottom: 5px;
        }

        .subtitle {
            text-align: center;
            font-size: 16px;
            margin-bottom: 25px;
        }

       /* =====================================================
   MENSAGENS INSTITUCIONAIS
   Frases tem√°ticas, comemorativas e informativas
   ===================================================== */
.institutional-highlight {
    text-align: center;
    font-size: 14px;
    color: var(--azul-marinho);

    font-weight: 500;
    font-style: italic;

    margin-bottom: 20px;
    padding: 12px;

    background-color: #fcfcfc;
    border: 1px solid #eee;
}

/* =====================================================
   MENSAGENS DE STATUS DO SISTEMA
   Sucesso | Erro | Carregamento
   ===================================================== */
.info-message {
    display: none;

    text-align: center;
    font-weight: 600;

    padding: 15px;
    margin-bottom: 20px;

    border-radius: 4px;
    border-left: 5px solid;

    transition: all 0.3s ease;
}

/* ----- Estado: Sucesso ----- */
.info-message.success {
    background-color: #e8f5e9;
    color: var(--sucesso);
    border-left-color: var(--sucesso);
}

/* ----- Estado: Erro ----- */
.info-message.error {
    background-color: #fce4ec;
    color: var(--erro);
    border-left-color: var(--erro);
}

/* ----- Estado: Carregando / Inicial ----- */
.info-message.loading {
    display: block;
    background-color: #eee;
    color: #666;
    border-left-color: #ccc;
}

/* =====================================================
   ESTADO DE SUCESSO FINAL (ENVIO CONCLU√çDO)
   ===================================================== */
#successState {
    display: none;
    text-align: center;
    padding: 20px;
}

.check-icon {
    font-size: 50px;
    color: var(--sucesso);
    margin-bottom: 15px;
}

        /* =========================================================
   BLOCO 3 ‚Äî FORMUL√ÅRIO, CAMPOS E VALIDA√á√ÉO
   Define apar√™ncia, espa√ßamento e estados dos inputs
   ========================================================= */

/* Estrutura base dos grupos */
.form-group,
fieldset {
    margin-bottom: 20px;
    width: 100%;
    border: none;
    padding: 0;
}

/* Labels e legendas */
label,
legend {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
}

/* Inputs e selects (exceto radio) */
.form-group input:not([type="radio"]),
.form-group select {
    width: 100%;
    padding: 12px;
    border: 1px solid var(--borda-campo);
    border-radius: 4px;
    box-sizing: border-box;
    font-size: 14px;
}

/* Campo somente leitura (nome) */
.form-group input[readonly] {
    background-color: #f0f0f0;
    cursor: not-allowed;
}

/* Estado v√°lido */
.is-valid {
    border-color: var(--sucesso) !important;
    box-shadow: 0 0 0 2px rgba(56, 142, 60, 0.1);
}

/* Estado inv√°lido */
.is-invalid {
    border-color: var(--erro) !important;
    box-shadow: 0 0 0 2px rgba(176, 0, 32, 0.1);
}

/* Mensagem de erro pequena (ex: matr√≠cula inv√°lida) */
#matriculaError {
    color: var(--erro);
    font-size: 12px;
    margin-top: 4px;
}

        /* =========================================================
   BLOCO 4 ‚Äî BOT√ïES DE R√ÅDIO (TIPO DE FOLGA)
   Radios estilizados como bot√µes institucionais
   ========================================================= */

/* Container dos bot√µes */
.radio-group-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

/* Esconde o radio nativo */
.radio-group-buttons input {
    display: none;
}

/* Apar√™ncia dos "bot√µes" */
.radio-group-buttons label {
    padding: 8px 12px;
    border: 1px solid #ccc;
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    user-select: none;
    transition: all 0.2s ease;
}

/* Hover sutil */
.radio-group-buttons label:hover {
    background-color: #f4f4f4;
}

/* Estado selecionado */
.radio-group-buttons input:checked + label {
    background-color: var(--azul-marinho);
    color: var(--dourado-amarelo);
    border-color: var(--azul-marinho);
}

        /* =========================================================
   BLOCO 5 ‚Äî BOT√ïES GERAIS E ESTADOS
   Bot√£o principal, secund√°rio e desabilitado
   ========================================================= */

/* Bot√£o padr√£o */
.button {
    width: 100%;
    padding: 14px;
    border-radius: 4px;
    border: none;
    cursor: pointer;

    background-color: var(--azul-claro-hover);
    color: #ffffff;

    font-size: 16px;
    font-weight: 700;
    text-transform: uppercase;

    transition: background-color 0.25s ease, transform 0.1s ease;
}

/* Feedback visual ao clicar */
.button:active {
    transform: scale(0.98);
}

/* Bot√£o secund√°rio (ex: hist√≥rico) */
.button.secondary {
    background-color: #ffffff;
    color: var(--azul-marinho);
    border: 1px solid var(--azul-marinho);
}

/* Hover */
.button:hover:not(:disabled) {
    background-color: var(--azul-marinho);
}

/* Hover do secund√°rio */
.button.secondary:hover:not(:disabled) {
    background-color: var(--azul-marinho);
    color: var(--dourado-amarelo);
}

/* Estado desabilitado */
.button:disabled {
    background-color: #cccccc;
    color: #666666;
    cursor: not-allowed;
    transform: none;
}

        /* =========================================================
   BLOCO 6 ‚Äî MODAIS, OVERLAY E SPINNER
   Estados globais do sistema (loading, hist√≥rico, alertas)
   ========================================================= */

/* Base comum de modal / overlay */
.modal-base {
    position: fixed;
    inset: 0;
    z-index: 2000;

    display: none;
    align-items: center;
    justify-content: center;

    background: rgba(0, 0, 0, 0.6);
}

/* Conte√∫do do modal */
.modal-content {
    background-color: #ffffff;
    border-radius: 8px;
    padding: 25px;

    width: 90%;
    max-width: 450px;
    max-height: 80vh;

    overflow-y: auto;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
}

/* Overlay espec√≠fico de carregamento */
#loadingOverlay {
    flex-direction: column;
    background: rgba(255, 255, 255, 0.9);
}

/* Spinner padr√£o */
.spinner {
    width: 30px;
    height: 30px;
    margin: 15px auto;

    border-radius: 50%;
    border: 4px solid rgba(0,0,0,0.1);
    border-top-color: var(--azul-claro-hover);

    animation: spin 1s linear infinite;
}

/* Anima√ß√µes */
@keyframes spin {
    100% {
        transform: rotate(360deg);
    }
}

@keyframes blinker {
    50% {
        opacity: 0;
    }
}

/* =========================================================
   BLOCO 7 ‚Äî FOOTER, TEXTOS AUXILIARES E ACABAMENTO FINAL
   ========================================================= */

/* Footer institucional (assinatura fina e discreta) */
.footer {
    margin-top: 20px;
    padding: 8px 10px;
    text-align: center;

    font-size: 10px;          /* menor e discreto */
    font-weight: 400;          /* leve */
    font-style: italic;        /* assinatura */
    color: #666;               /* cor suave */

    border-top: 1px solid #ddd;
}

/* Texto auxiliar (observa√ß√µes, notas, avisos) */
.texto-auxiliar {
    font-size: 12px;
    color: #555;
    margin-top: 8px;
}

/* Estado vazio (ex: hist√≥rico sem registros) */
.estado-vazio {
    text-align: center;
    padding: 20px 10px;
    font-size: 13px;
    color: #777;
    font-style: italic;
}

/* Pequenos ajustes gerais */
.hidden {
    display: none !important;
}

/* Responsividade final */
@media (max-width: 480px) {
    h1 {
        font-size: 20px;
    }

    .card {
        padding: 15px;
    }

    button {
        font-size: 14px;
    }

    .footer {
        font-size: 9px; /* ainda mais discreto em telas pequenas */
    }
}
        
</style>
</head>

<body>
    <!-- Overlay de carregamento enquanto o formul√°rio est√° sendo enviado -->
    <div id="loadingOverlay" class="modal-base" style="flex-direction: column; background: rgba(255,255,255,0.9);">
        <p style="color: var(--azul-marinho); font-weight: bold;">Enviando sua solicita√ß√£o...</p>
        <div class="spinner"></div>
    </div>

    <!-- Modal de hist√≥rico de solicita√ß√µes do usu√°rio -->
    <div id="historyModal" class="modal-base">
        <div class="modal-content">
            <h3 style="color:var(--azul-marinho); margin-top:0;">Hist√≥rico Recente</h3>
            <div id="historyBox"></div>
            <button type="button" class="button" id="closeHistory">Fechar</button>
        </div>
    </div>

    <div class="container">
    <!-- Barra de progresso indicando preenchimento do formul√°rio -->
    <div id="progressBarContainer"><div id="progressBar"></div></div>
    
    <!-- Logos institucionais -->
    <div class="logos">
        <img src="https://rondonia.ro.gov.br/wp-content/uploads/2024/09/Brasao-PMRO-370x523.png" alt="PMRO">
        <img src="https://museu.pm.ro.gov.br/wp-content/uploads/2024/05/1-bpm-3.png" alt="1¬∫ BPM">
    </div>

    <!-- T√≠tulo principal e subt√≠tulo -->
    <h2>DERSO 1¬∫ BPM</h2>
    <p class="subtitle">Solicita√ß√£o de Di√°ria Especial de Refor√ßo do Servi√ßo Operacional - DERSO</p>

    <!-- Mensagem institucional din√¢mica (datas comemorativas ou alertas) -->
    <div id="instMessage" class="institutional-highlight"></div>

    <!-- Mensagem de prazo do formul√°rio (aberto, fechado, urg√™ncia) -->
    <div id="prazoMessage" class="info-message loading">‚åõ Verificando prazos do sistema...</div>

    <!-- Estado de sucesso ap√≥s envio -->
    <div id="successState">
        <div class="check-icon">‚úì</div>
        <h3 style="color: var(--sucesso)">ENVIADO COM SUCESSO!</h3>
        <p>Sua solicita√ß√£o foi registrada no sistema.</p>
        <button class="button" onclick="location.reload()">Fazer outra solicita√ß√£o</button>
    </div>

    <!-- Carregamento inicial do sistema antes do formul√°rio aparecer -->
    <div id="initialLoading">
        <p style="text-align:center">Carregando sistema...</p>
        <div class="spinner"></div>
    </div>

        <form id="dersoForm" style="display: none;">
    <!-- E-mail -->
    <div class="form-group">
        <label for="email">E-mail:</label>
        <input type="email" id="email" name="email" list="emailProviders" required>
        <datalist id="emailProviders"></datalist>
    </div>

    <!-- Matr√≠cula -->
    <div class="form-group">
        <label for="matricula">Matr√≠cula:</label>
        <input type="text" id="matricula" name="matricula" required placeholder="Ex: 12345">
        <div id="matriculaError" style="color:var(--erro); font-size:12px; margin-top:4px;"></div>
    </div>

    <!-- Nome preenchido automaticamente -->
    <div class="form-group">
        <label for="nome">Nome:</label>
        <input type="text" id="nome" name="nome" readonly required style="background:#f0f0f0">
    </div>

    <!-- Tipo de folga -->
    <fieldset>
        <legend>Tipo de Folga:</legend>
        <div class="radio-group-buttons">
            <input type="radio" id="folga24H" name="folga" value="24H" required><label for="folga24H">24H</label>
            <input type="radio" id="folga48H" name="folga" value="48H"><label for="folga48H">48H</label>
            <input type="radio" id="folga72H" name="folga" value="72H"><label for="folga72H">72H</label>
            <input type="radio" id="folga96H" name="folga" value="96H"><label for="folga96H">96H</label>
            <input type="radio" id="folgaLE" name="folga" value="FOLGA LE"><label for="folgaLE">FOLGA LE</label>
            <input type="radio" id="folga1" name="folga" value="1¬™ Folga"><label for="folga1">1¬™ FOLGA</label>
            <input type="radio" id="folga2" name="folga" value="2¬™ Folga"><label for="folga2">2¬™ FOLGA</label>
            <input type="radio" id="folgaExp" name="folga" value="Expediente"><label for="folgaExp">EXPEDIENTE</label>
        </div>
    </fieldset>

    <!-- Data da folga -->
    <div class="form-group">
        <label for="data">Data da Folga:</label>
        <input type="date" id="data" name="data" required>
        <div id="dateLimitMessage" style="font-size: 11px; color: #666; margin-top: 5px;"></div>
    </div>

    <!-- Bot√µes: Hist√≥rico e Enviar -->
    <button type="button" class="button secondary" id="btnHistory">Minhas Solicita√ß√µes</button>
    <button type="submit" class="button" id="btnSubmit">Enviar Solicita√ß√£o</button>
</form>

<!-- Mensagem de status do formul√°rio -->
<div id="statusMessage" class="info-message"></div>

<!-- Rodap√© institucional -->
<div class="footer" id="footerText"></div>

        <!-- BLOCO 10: SCRIPTS PRINCIPAIS -->
<script>
    // URL do Google Apps Script que processa solicita√ß√µes
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxyIEtO9JwtnSHDZsajqXGSz_ONjIrbN2gdMW6kcPBjYsjByK55AmkAz2Ov8YesV7cKDA/exec";
    
    // Lista de provedores de email para sugest√£o autom√°tica
    const emailProviders = ["gmail.com","hotmail.com","outlook.com","pm.ro.gov.br", "yahoo.com"];
    
    // Objeto global para armazenar funcion√°rios carregados da planilha
    window.employeeList = {};

    // Refer√™ncias a elementos do DOM
    const matInput = document.getElementById("matricula");
    const nomeInput = document.getElementById("nome");
    const matError = document.getElementById("matriculaError");
    const formDiv = document.getElementById("dersoForm");
    const prazoMessageDiv = document.getElementById("prazoMessage");

    /** Fun√ß√£o para exibir mensagens persistentes de status ou erro */
    function showPersistentMessage(msg, type="success") {
        prazoMessageDiv.className = `info-message ${type}`;
        prazoMessageDiv.innerHTML = msg;
        prazoMessageDiv.style.display = "block";
    }

    /** Padroniza matr√≠cula: remove caracteres n√£o num√©ricos e garante in√≠cio com '1000' */
    function standardizeMatricula(m) {
        let num = m.replace(/\D/g,'').slice(0,9);
        if (!num) return "";
        return num.startsWith("1000") ? num : "1000" + num;
    }

    /** Valida matr√≠cula ao sair do campo */
    function checkMatricula() {
        const val = matInput.value.trim();
        if (!val) {
            nomeInput.value = "";
            matInput.classList.remove("is-valid", "is-invalid");
            return;
        }
        const std = standardizeMatricula(val);
        matInput.value = std;
        if (window.employeeList[std]) {
            nomeInput.value = window.employeeList[std];
            matInput.classList.add("is-valid");
            matInput.classList.remove("is-invalid");
            matError.textContent = "";
        } else {
            nomeInput.value = "";
            matInput.classList.add("is-invalid");
            matInput.classList.remove("is-valid");
            matError.textContent = "Matr√≠cula n√£o cadastrada.";
        }
    }

    /** Inicializa formul√°rio: datas, prazos, lista de funcion√°rios */
    function initializeForm() {
        // Promessas para buscar datas de abertura/fechamento e lista de funcion√°rios
        const datasPromise = fetch(`${SCRIPT_URL}?action=datas`).then(r => r.json());
        const listaPromise = fetch(`${SCRIPT_URL}?action=lista`).then(r => r.json());

        datasPromise.then(data => {
            // Fun√ß√£o que atualiza cron√¥metro do prazo
            const atualizarCronometro = () => {
                const agora = new Date();
                const abertura = new Date(data.abertura);
                const fechamento = new Date(data.fechamento);

                // Antes da abertura
                if (agora < abertura) {
                    const diffA = abertura - agora;
                    const d = Math.floor(diffA / (1000 * 60 * 60 * 24));
                    const h = Math.floor((diffA % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const m = Math.floor((diffA % (1000 * 60 * 60)) / (1000 * 60));
                    const s = Math.floor((diffA % (1000 * 60)) / 1000);
                    showPersistentMessage(`‚è≥ <b>FORMUL√ÅRIO FECHADO</b><br>Abre em: ${d}d ${h}h ${m}m ${s}s`, "error");
                    formDiv.style.display = "none";
                    return false;
                } 
                // Ap√≥s fechamento
                else if (agora > fechamento) {
                    showPersistentMessage(`‚õî <b>FORMUL√ÅRIO ENCERRADO</b><br>O prazo terminou em ${fechamento.toLocaleString("pt-BR")}`, "error");
                    formDiv.style.display = "none";
                    return false;
                } 
                // Durante per√≠odo aberto
                else {
                    const diffF = fechamento - agora;
                    const d = Math.floor(diffF / (1000 * 60 * 60 * 24));
                    const h = Math.floor((diffF % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const m = Math.floor((diffF % (1000 * 60 * 60)) / (1000 * 60));
                    const s = Math.floor((diffF % (1000 * 60)) / 1000);
                    const tempoTexto = `${d}d ${h}h ${m}m ${s}s`;

                    if (diffF < (2 * 60 * 60 * 1000)) {
                        showPersistentMessage(`‚ö†Ô∏è <b style="animation:blinker 1s infinite">URGENTE! FECHA EM:</b><br><span style="color:#ff0000; font-size:1.2em;">${tempoTexto}</span>`, "error");
                    } else {
                        showPersistentMessage(`üö® <b>FORMUL√ÅRIO ABERTO</b><br>Encerra em: <b>${tempoTexto}</b>`, "success");
                    }
                    return true;
                }
            };

            // Atualiza cron√¥metro imediatamente
            const estaAberto = atualizarCronometro();

            // Intervalo de 1 segundo para manter contador atualizado
            setInterval(() => {
                const statusAtual = atualizarCronometro();
                if (statusAtual && formDiv.style.display === "none") {
                    location.reload();
                }
            }, 1000);

            // Se aberto, carregamos lista de funcion√°rios e exibimos o formul√°rio
            if (estaAberto) {
                listaPromise.then(listaData => {
                    window.employeeList = listaData;
                    document.getElementById("initialLoading").style.display = "none";
                    formDiv.style.display = "block";
                });
            } else {
                document.getElementById("initialLoading").style.display = "none";
            }
        });

        // Configura√ß√£o do limite de datas para o input
        const hoje = new Date();
        const min = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 1);
        const max = new Date(hoje.getFullYear(), hoje.getMonth() + 2, 0);
        document.getElementById("data").min = min.toISOString().split("T")[0];
        document.getElementById("data").max = max.toISOString().split("T")[0];
        document.getElementById("dateLimitMessage").textContent = `Agendamento para: ${min.toLocaleDateString('pt-BR')} at√© ${max.toLocaleDateString('pt-BR')}`;
        document.getElementById("footerText").textContent = `Desenvolvido na 1¬™ Cia do 1¬∫ BPM pelo PVSA Pedro Porto - ${(hoje.getMonth() + 1).toString().padStart(2, '0')}/${hoje.getFullYear()}`;
    }

    <!-- BLOCO 11: ENVIO, HIST√ìRICO E PROGRESSO -->

            /** Fun√ß√£o para enviar o formul√°rio de solicita√ß√£o */
async function submitForm(e) {
  e.preventDefault(); // N√ÉO recarrega a p√°gina

  const matricula = document.getElementById("matricula").value.trim();
  const nome = document.getElementById("nome").value.trim();
  const email = document.getElementById("email").value.trim();
  const data = document.getElementById("data").value;
  const folga = document.getElementById("folga").value;

  console.log(`[SUBMIT] Verificando duplicidade para matr√≠cula ${matricula} e data ${data}...`);

  // Checa duplicidade via GET
  const historicoResp = await fetch(`${GAS_URL}?action=historico&matricula=${matricula}`);
  const historicoJSON = await historicoResp.json();
  console.log("[SUBMIT] Hist√≥rico retornado:", historicoJSON);

  const duplicado = historicoJSON.historico.some(item => item.Data === data);
  if (duplicado) {
    console.warn("[SUBMIT] Solicita√ß√£o DUPLICADA detectada!");
    alert("Voc√™ j√° solicitou DERSO para esta data. Verifique seu hist√≥rico.");
    return;
  }

  console.log("[SUBMIT] Nenhuma duplicidade. Enviando solicita√ß√£o...");

  // POST da solicita√ß√£o
  try {
    const resp = await fetch(GAS_URL, {
      method: "POST",
      body: new URLSearchParams({ matricula, nome, email, data, folga })
    });

    const result = await resp.json();
    console.log("[SUBMIT] Resposta do POST:", result);

    if (result.success) {
      alert(`‚úÖ SUCESSO!\nSua solicita√ß√£o foi registrada para ${data}`);
      document.getElementById("data").value = ""; // limpa apenas o dia
    } else if (result.error) {
      alert(`‚ö†Ô∏è ERRO: ${result.error}`);
    }

  } catch (err) {
    console.error("[SUBMIT] Erro ao enviar solicita√ß√£o:", err);
    alert("‚ùå Falha ao enviar. Veja o console para detalhes.");
  }
}

    /** Aplica mensagens institucionais de acordo com datas especiais ou mensais */
    function applyInstitutionalTheme() {
        const hoje = new Date(), mes = hoje.getMonth(), dia = hoje.getDate();
        const instDiv = document.getElementById("instMessage");
        const aplicar = (msg) => instDiv.innerHTML = msg;

        const temas = {
            "1-4": () => aplicar(`üå≥ Rond√¥nia: ${hoje.getFullYear() - 1982} anos de hist√≥ria, bravura e compromisso.`),
            "5-1": () => aplicar("üõ†Ô∏è Dia do Trabalhador: O servi√ßo p√∫blico √© a engrenagem que move a cidadania."),
            "9-7": () => aplicar("üáßüá∑ 7 de Setembro: A independ√™ncia se constr√≥i com ordem, progresso e seguran√ßa."),
            "11-15": () => aplicar(`üìú 15 de Novembro: A Rep√∫blica se fortalece com institui√ß√µes s√≥lidas. ${hoje.getFullYear() - 1889} anos de Proclama√ß√£o.`),
            "11-20": () => aplicar("‚úä Consci√™ncia Negra: A uni√£o e o respeito √†s ra√≠zes constroem uma sociedade justa. ‚öñÔ∏è"),
            "12-7": () => aplicar(`üõ°Ô∏è 1¬∫ BPM: O Sentinela da Capital. ${hoje.getFullYear() - 1983} anos de tradi√ß√£o e compromisso.`)
        };

        const chave = `${mes+1}-${dia}`;
        if (temas[chave]) {
            temas[chave]();
        } else {
            const mensais = {
                0: () => aplicar("üé≠ Janeiro: Planejamento estrat√©gico para garantir a seguran√ßa em grandes eventos e festas."),
                1: () => aplicar("üéä Fevereiro: Foco e preven√ß√£o. Nossa miss√£o √© garantir a tranquilidade de todos."),
                2: () => aplicar("üå∑ Mar√ßo: Homenagem √†s mulheres da Corpora√ß√£o que honram a farda com dedica√ß√£o."),
                3: () => aplicar("üïäÔ∏è Abril: Tempo de renova√ß√£o, reflex√£o e fortalecimento da uni√£o familiar."),
                4: () => aplicar("ü§± Maio: M√£es, a base de tudo. Reconhecemos sua dupla miss√£o de cuidar e proteger."),
                5: () => aplicar("üî• Junho: Valorizando a cultura e as tradi√ß√µes que formam nossa identidade social."),
                6: () => aplicar("üëÆ Julho: Disciplina e prontid√£o no policiamento ostensivo."),
                7: () => aplicar("üëî Agosto: A presen√ßa familiar √© o alicerce para o equil√≠brio do profissional de seguran√ßa."),
                8: () => aplicar("üáßüá∑ Setembro: M√™s da P√°tria. Renovando nosso juramento de servir e proteger o Brasil."),
                9: () => aplicar("üéóÔ∏è Outubro: Preven√ß√£o √© o melhor caminho para a sa√∫de."),
                10: () => aplicar(`üìú Novembro: Compromisso republicano e respeito √† diversidade que formam nossa na√ß√£o. ${hoje.getFullYear() - 1889}¬∫ ano da Rep√∫blica.`),
                11: () => aplicar("üéÑ Dezembro: Planejamento e compromisso garantem um final de ano seguro. Boas Festas! ‚ú®")
            };
            if (mensais[mes]) mensais[mes]();
        }
    }

    /** Evento DOMContentLoaded: inicializa formul√°rio, temas, hist√≥rico e valida√ß√£o de campos */
    document.addEventListener("DOMContentLoaded", () => {
        initializeForm();                  // Carrega datas, lista e configura limites
        applyInstitutionalTheme();         // Aplica mensagens institucionais

        matInput.addEventListener("blur", checkMatricula);  // Valida matr√≠cula ao sair do campo
        formDiv.addEventListener("submit", submitForm);    // Submiss√£o do formul√°rio

        // Sugest√£o autom√°tica de emails
        document.getElementById("email").addEventListener("input", (e) => {
            const val = e.target.value;
            const dl = document.getElementById("emailProviders");
            if (val.includes("@")) {
                const [user, domain] = val.split("@");
                dl.innerHTML = "";
                emailProviders.forEach(p => {
                    if (p.startsWith(domain)) dl.appendChild(new Option(user + "@" + p));
                });
            }
        });

        /** Atualiza a barra de progresso baseada em campos preenchidos */
        const updateProgress = () => {
            const fields = document.querySelectorAll('#dersoForm [required]');
            let filled = 0;
            fields.forEach(f => {
                if (f.type === 'radio') {
                    if (document.querySelector('input[name="folga"]:checked')) filled++;
                } else if (f.value.trim() !== '' && !f.classList.contains('is-invalid')) {
                    filled++;
                }
            });
            const percent = (filled / 4) * 100;  // Considera 4 campos essenciais
            document.getElementById("progressBar").style.width = percent + "%";
        };

        document.querySelectorAll('#dersoForm input').forEach(i => {
            i.addEventListener('input', updateProgress);
            i.addEventListener('blur', updateProgress);
        });

        /** BOT√ÉO DE HIST√ìRICO: exibe modal com hist√≥rico de solicita√ß√µes */
        document.getElementById("btnHistory").onclick = async () => {
            if (!matInput.value || matInput.classList.contains("is-invalid")) return alert("Insira uma matr√≠cula v√°lida.");
            const modal = document.getElementById("historyModal");
            modal.style.display = "flex";
            document.getElementById("historyBox").innerHTML = "<div class='spinner'></div> Buscando...";

            try {
                const r = await fetch(`${SCRIPT_URL}?action=historico&matricula=${matInput.value}`);
                const d = await r.json();
                
                let h = `<div style="font-weight:bold; border-bottom:2px solid var(--dourado-amarelo);">${d.nome || 'Solicitante'}</div>`;
                
                if (!d.historico || d.historico.length === 0) h += "Nenhum registro.";
                else d.historico.forEach(i => {
                    const statusTexto = (i.status && i.status !== "PENDENTE") ? ` (${i.status})` : "";
                    h += `<div style="border-bottom:1px solid #eee; padding:8px 0;">
                            ${i.dataSolicitada} - ${i.tipoDeFolga}${statusTexto}
                          </div>`;
                });

                document.getElementById("historyBox").innerHTML = h;
            } catch (err) {
                document.getElementById("historyBox").innerHTML = "Erro ao carregar.";
            }
        };

        /** Fechar modal de hist√≥rico */
        document.getElementById("closeHistory").onclick = () => {
            document.getElementById("historyModal").style.display="none";
        };
    });

    <!-- BLOCO 12: FUN√á√ïES FINAIS, UTILIT√ÅRIOS E FECHAMENTO -->

       /**************************************************************
     * FUN√á√ïES AUXILIARES E UTILIT√ÅRIOS
     **************************************************************/

    /** Formata datas no padr√£o dd/MM/yyyy a partir de Date ou string */
    function formatDateBR(input) {
        if (!input) return "";
        if (input instanceof Date) {
            const dia = input.getDate().toString().padStart(2, '0');
            const mes = (input.getMonth() + 1).toString().padStart(2, '0');
            const ano = input.getFullYear();
            return `${dia}/${mes}/${ano}`;
        }
        // Caso seja string yyyy-mm-dd
        const parts = input.split("-");
        if (parts.length === 3) return `${parts[2]}/${parts[1]}/${parts[0]}`;
        return input;
    }

    /** Normaliza matr√≠cula removendo caracteres n√£o num√©ricos e adicionando prefixo 1000 se necess√°rio */
    function normalizeMatricula(m) {
        if (!m) return "";
        let num = m.replace(/\D/g,'').slice(0,9);
        return num.startsWith("1000") ? num : "1000" + num;
    }

    /** Abre um modal e insere conte√∫do HTML */
    function showModal(modalId, contentHtml) {
        const modal = document.getElementById(modalId);
        if (!modal) return;
        const box = modal.querySelector("#historyBox");
        if (box) box.innerHTML = contentHtml;
        modal.style.display = "flex";
    }

    /** Fecha um modal */
    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (!modal) return;
        modal.style.display = "none";
    }

    /** Atualiza barra de progresso (reaproveita l√≥gica do bloco anterior) */
    function updateProgressBar() {
        const fields = document.querySelectorAll('#dersoForm [required]');
        let filled = 0;
        fields.forEach(f => {
            if (f.type === 'radio') {
                if (document.querySelector('input[name="folga"]:checked')) filled++;
            } else if (f.value.trim() !== '' && !f.classList.contains('is-invalid')) {
                filled++;
            }
        });
        const percent = (filled / 4) * 100;
        document.getElementById("progressBar").style.width = percent + "%";
    }

    /** Pequenas otimiza√ß√µes: atualiza progresso automaticamente em blur/input */
    document.querySelectorAll('#dersoForm input, #dersoForm select').forEach(i => {
        i.addEventListener('input', updateProgressBar);
        i.addEventListener('blur', updateProgressBar);
    });

    /** Inicializa√ß√£o final: quando tudo est√° carregado */
    window.addEventListener('load', () => {
        updateProgressBar(); // Garante que progresso inicial seja correto
    });

</script>

</body>
</html>

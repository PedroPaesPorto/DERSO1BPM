<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicita√ß√£o de Folga - DERSO</title>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --azul-marinho: #0C3667;
            --dourado-amarelo: #FFD700;
            --azul-claro-hover: #1a5ca7;
            --erro: #b00020;
            --sucesso: #388e3c;
            --cinza-fundo: #f4f7f9;
            --cinza-texto: #333333;
            --borda-campo: #aaa;
        }

        body { background-color: var(--cinza-fundo); font-family: 'Roboto', sans-serif; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        
        .container { 
            width: 95%; max-width: 500px; background: #fff; border-radius: 8px; padding: 30px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.15); border: 1px solid #ccc; position: relative; 
        }

        #progressBarContainer { position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: #e0e0e0; overflow: hidden; }
        #progressBar { width: 0%; height: 100%; background: var(--dourado-amarelo); transition: width 0.4s; }

        .logos { display: flex; justify-content: center; gap: 15px; margin-bottom: 15px; }
        .logos img { height: 70px; }

        h2 { 
            font-family: 'Merriweather', serif; text-align: center; color: var(--azul-marinho); 
            font-size: 26px; border-bottom: 2px solid var(--dourado-amarelo); padding-bottom: 5px; margin-bottom: 10px;
        }

        .subtitle { text-align: center; font-size: 15px; color: #666; margin-bottom: 25px; }

        .form-group { margin-bottom: 18px; }
        label { display: block; margin-bottom: 6px; font-weight: 500; color: var(--cinza-texto); }
        
        input:not([type="radio"]) { 
            width: 100%; padding: 12px; border: 1px solid var(--borda-campo); border-radius: 4px; box-sizing: border-box; 
        }

        /* Estilo para destacar campos bloqueados (Nome) */
        input[readonly] { background-color: #f0f0f0; cursor: not-allowed; border-color: #ddd; }

        /* Bot√µes de Folga */
        .radio-group-buttons { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px; }
        .radio-group-buttons input { display: none; }
        .radio-group-buttons label { 
            padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; 
            font-size: 13px; font-weight: 600; text-transform: uppercase; transition: 0.2s;
        }
        .radio-group-buttons input:checked + label { 
            background: var(--azul-marinho); color: var(--dourado-amarelo); border-color: var(--azul-marinho); 
        }

        .button { 
            width: 100%; padding: 15px; background: var(--azul-claro-hover); color: #fff; border: none; 
            border-radius: 4px; font-weight: 700; text-transform: uppercase; cursor: pointer; margin-top: 10px;
        }
        .button:hover { background: var(--azul-marinho); }

        .btn-historico { 
            width: 100%; background: none; border: 1px solid #ccc; color: #666; 
            padding: 8px; margin-top: 10px; cursor: pointer; font-size: 12px; border-radius: 4px;
        }

        /* Mensagem de Prazo Estilo HTML 1 */
        .info-message { 
            padding: 15px; border-radius: 4px; margin-bottom: 20px; text-align: center; 
            font-weight: 600; display: none; border-left: 5px solid; 
        }
        .info-message.success { background: #e8f5e9; color: var(--sucesso); border-left-color: var(--sucesso); }
        .info-message.error { background: #fce4ec; color: var(--erro); border-left-color: var(--erro); }

        #loadingOverlay { 
            position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 1000; 
            display: none; flex-direction: column; align-items: center; justify-content: center; 
        }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--azul-claro-hover); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Modal Hist√≥rico */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1100; }
        .modal-content { background: #fff; padding: 25px; border-radius: 8px; width: 90%; max-width: 400px; }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <p id="loadingText">Processando...</p>
    <div class="spinner"></div>
</div>

<div class="container">
    <div id="progressBarContainer"><div id="progressBar"></div></div>
    
    <div class="logos">
        <img src="https://rondonia.ro.gov.br/wp-content/uploads/2024/09/Brasao-PMRO-370x523.png" alt="PMRO">
        <img src="https://museu.pm.ro.gov.br/wp-content/uploads/2024/05/1-bpm-3.png" alt="1¬∫ BPM">
    </div>

    <h2>DERSO 1¬∫ BPM</h2>
    <p class="subtitle">Formul√°rio de Solicita√ß√£o de Di√°ria Especial de Refor√ßo do Servi√ßo Operacional - DERSO</p>

    <div id="prazoStatus" class="info-message"></div>

    <div id="formContent" style="display: none;">
        <form id="dersoForm">
            <div class="form-group">
                <label>E-mail:</label>
                <input type="email" name="email" required>
            </div>

            <div class="form-group">
                <label>Matr√≠cula:</label>
                <input type="text" id="matricula" name="matricula" required placeholder="Ex: 100012345">
                <div id="matError" style="color:var(--erro); font-size:12px; margin-top:4px; font-weight:600"></div>
            </div>

            <div class="form-group">
                <label>Nome:</label>
                <input type="text" id="nome" name="nome" readonly required placeholder="Nome autom√°tico">
            </div>

            <div class="form-group">
                <label>Tipo de Folga*:</label>
                <div class="radio-group-buttons">
                    <input type="radio" id="f24" name="folga" value="24H" required><label for="f24">24H</label>
                    <input type="radio" id="f48" name="folga" value="48H"><label for="f48">48H</label>
                    <input type="radio" id="f72" name="folga" value="72H"><label for="f72">72H</label>
                    <input type="radio" id="f96" name="folga" value="96H"><label for="f96">96H</label>
                    <input type="radio" id="fLE" name="folga" value="FOLGA LE"><label for="fLE">FOLGA LE</label>
                    <input type="radio" id="f1" name="folga" value="1¬™ FOLGA"><label for="f1">1¬™ FOLGA</label>
                    <input type="radio" id="f2" name="folga" value="2¬™ FOLGA"><label for="f2">2¬™ FOLGA</label>
                    <input type="radio" id="fEX" name="folga" value="EXPEDIENTE"><label for="fEX">EXPEDIENTE</label>
                </div>
            </div>

            <div class="form-group">
                <label>Data da Folga (Pr√≥ximo M√™s):</label>
                <input type="date" id="dataInput" name="data" required>
                <div id="dateHelp" style="font-size:11px; color:#777; margin-top:5px"></div>
            </div>

            <button type="submit" class="button">Enviar Solicita√ß√£o</button>
            <button type="button" id="btnHist" class="btn-historico">SOLICITA√á√ïES</button>
        </form>
    </div>
</div>

<div id="modalHist" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0; color:var(--azul-marinho)">Meu Hist√≥rico</h3>
        <div id="histLista" style="max-height:250px; overflow-y:auto; font-size:13px"></div>
        <button onclick="closeM()" class="button" style="padding:10px">Fechar</button>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz7-pdQ3f8UMXZylF-4M4Qai6UWGsXPdqfYhoyuPuEVBL_nbBrCn2DfyfpHVmgAFEhh/exec";
    let listaFuncionarios = {};

    async function iniciar() {
        document.getElementById('loadingOverlay').style.display = 'flex';
        
        try {
            // 1. Carregar lista para busca instant√¢nea de matr√≠cula
            const resLista = await fetch(SCRIPT_URL + "?action=lista");
            listaFuncionarios = await resLista.json();

            // 2. Verificar Prazos (MELHORIA 2)
            const resStatus = await fetch(SCRIPT_URL + "?action=datas");
            const status = await resStatus.json();
            validarPrazos(status);

            // 3. Configurar Calend√°rio (MELHORIA 1)
            travarCalendario();

            document.getElementById('loadingOverlay').style.display = 'none';
        } catch(e) {
            alert("Erro de conex√£o com o servidor.");
        }
    }

    function validarPrazos(d) {
        const agora = new Date();
        const abertura = new Date(d.abertura);
        const fechamento = new Date(d.fechamento);
        const statusDiv = document.getElementById('prazoStatus');
        const content = document.getElementById('formContent');

        if (agora < abertura) {
            statusDiv.innerHTML = `‚è≥ ABERTURA DO FORMUL√ÅRIO: <br>${abertura.toLocaleString()}`;
            statusDiv.className = "info-message error";
            statusDiv.style.display = "block";
        } else if (agora > fechamento) {
            statusDiv.innerHTML = `‚õî Inscri√ß√µes encerradas em: <br>${fechamento.toLocaleString()}`;
            statusDiv.className = "info-message error";
            statusDiv.style.display = "block";
        } else {
            statusDiv.innerHTML = `‚úÖ Per√≠odo Aberto! <br> Fecha em: ${fechamento.toLocaleDateString()}`;
            statusDiv.className = "info-message success";
            statusDiv.style.display = "block";
            content.style.display = "block"; // S√≥ mostra o formul√°rio se estiver no prazo
        }
    }

    function travarCalendario() {
        const input = document.getElementById('dataInput');
        const help = document.getElementById('dateHelp');
        const hoje = new Date();
        
        // Define o primeiro e √∫ltimo dia do M√äS SEGUINTE
        const inicio = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 1);
        const fim = new Date(hoje.getFullYear(), hoje.getMonth() + 2, 0);

        const minStr = inicio.toISOString().split('T')[0];
        const maxStr = fim.toISOString().split('T')[0];

        input.min = minStr;
        input.max = maxStr;
        input.value = minStr; // Pr√©-seleciona a primeira data v√°lida
        
        help.textContent = `Apenas datas entre ${inicio.toLocaleDateString()} e ${fim.toLocaleDateString()}.`;
    }

    // Busca de Matr√≠cula Instant√¢nea (HTML 1)
    document.getElementById('matricula').addEventListener('blur', function() {
        let mat = this.value.replace(/\D/g,'');
        if (mat && !mat.startsWith("1000")) mat = "1000" + mat;
        this.value = mat;

        const nomeInput = document.getElementById('nome');
        const erro = document.getElementById('matError');

        if (listaFuncionarios[mat]) {
            nomeInput.value = listaFuncionarios[mat];
            erro.textContent = "";
        } else {
            nomeInput.value = "";
            if(mat) erro.textContent = "Matr√≠cula n√£o encontrada!";
        }
    });

    // Hist√≥rico Corrigido (Sem o Status Pendente)
document.getElementById('btnHist').onclick = async () => {
    const mat = document.getElementById('matricula').value;
    if (!mat) return alert("Insira a matr√≠cula para consultar.");
    
    document.getElementById('loadingOverlay').style.display = 'flex';
    try {
        const res = await fetch(`${SCRIPT_URL}?action=historico&matricula=${mat}`);
        const data = await res.json();
        let h = "";
        if (data.historico?.length) {
            data.historico.forEach(i => {
                // Removemos o (${i.Status}) daqui para n√£o aparecer "PENDENTE"
                h += `<div style="border-bottom:1px solid #eee; padding:10px 5px"><b>üìÖ ${i.Data}</b> - ${i.Folga}</div>`;
            });
        } else { h = "<p style='text-align:center'>Nenhuma solicita√ß√£o encontrada.</p>"; }
        document.getElementById('histLista').innerHTML = h;
        document.getElementById('modalHist').style.display = 'flex';
    } catch(e) { alert("Erro ao buscar hist√≥rico."); }
    document.getElementById('loadingOverlay').style.display = 'none';
};

    document.getElementById('dersoForm').onsubmit = async (e) => {
        e.preventDefault();
        document.getElementById('loadingOverlay').style.display = 'flex';
        
        const fd = new FormData(e.target);
        const params = new URLSearchParams(fd);
        // Formata data para o Sheets (DD/MM/YYYY)
        const dOriginal = document.getElementById('dataInput').value;
        params.set("data", dOriginal.split('-').reverse().join('/'));

        try {
            const res = await fetch(SCRIPT_URL, { method: "POST", body: params });
            const r = await res.json();
            if (r.success) { alert("Solicita√ß√£o enviada!"); location.reload(); }
            else { alert("Erro: " + r.error); }
        } catch(e) { alert("Erro na submiss√£o."); }
        document.getElementById('loadingOverlay').style.display = 'none';
    };

    function closeM() { document.getElementById('modalHist').style.display = 'none'; }

    window.onload = iniciar;
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
   <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicita√ß√£o de Folga - DERSO 1¬∫ BPM</title>
    
   <link rel="icon" type="image/png" href="favicon.png">

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root {
    --azul-marinho: #1A3C6E;
    --azul-hover: #255599;
    --ouro-brilhante: #FFD700;
    --sucesso-verde: #2E7D32;
    --alerta-laranja: #ef6c00;
    --critico-vermelho: #D32F2F;
    --cinza-fundo: #F0F2F5;
    --raio-padrao: 10px;
    --sombra-suave: 0 10px 25px rgba(0, 0, 0, 0.05);
    --transicao: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

* { box-sizing: border-box; }

body {
    background-color: var(--cinza-fundo);
    font-family: 'Roboto', sans-serif;
    margin: 0;
    padding: 20px 10px;
    display: flex;
    justify-content: center;
    color: #333;
}

.container {
    width: 100%;
    max-width: 500px;
    background: #fff;
    border-radius: var(--raio-padrao);
    padding: 35px 25px;
    box-shadow: var(--sombra-suave);
    position: relative;
    overflow: hidden;
}

/* Barra de progresso */
#barraProgresso {
    position: absolute;
    top: 0;
    left: 0;
    width: 0%;
    height: 5px;
    background: var(--ouro-brilhante);
    transition: width 0.5s ease;
    z-index: 3;
}

.barra-completa {
    animation: brilho 1s ease-in-out;
}

@keyframes brilho {
    0% { box-shadow: 0 0 0 rgba(46,125,50,0); }
    50% { box-shadow: 0 0 12px rgba(46,125,50,0.6); }
    100% { box-shadow: 0 0 0 rgba(46,125,50,0); }
}

/* HEADER */
.header {
    padding-bottom: 20px;
    background: linear-gradient(180deg, rgba(26,60,110,0.05), transparent);
    border-radius: 12px;
    text-align: center;
}

.logos {
    background: #f8fafc;
    padding: 10px 15px;
    border-radius: 12px;
    box-shadow: inset 0 0 0 1px rgba(0,0,0,0.05);

    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
}

.logos img {
    height: 75px;
    filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
    transition: var(--transicao);
}

.logos img:hover {
    transform: scale(1.05);
}

h2 {
    color: var(--azul-marinho);
    font-size: 22px;
    margin: 20px 0 0;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-weight: 900;
    text-align: center;
}

.divisor {
    width: 85%;
    max-width: 420px;
    height: 3px;
    background: linear-gradient(90deg, transparent, var(--ouro-brilhante), transparent);
    margin: 12px auto 20px;
    border-radius: 5px;
}

.subtitle {
    font-size: 13px;
    color: #555;
    line-height: 1.5;
    margin-bottom: 25px;
    font-weight: 500;
    text-align: center;
}

/* PRAZOBOX */
#prazoBox {
    padding: 20px;
    text-align: center;
    border-radius: var(--raio-padrao);
    margin-bottom: 25px;
    transition: var(--transicao);
    border: 2px solid #e5e7eb;
    background: linear-gradient(180deg, #fafafa, #ffffff);
}

/* T√≠tulo */
#prazoBox strong {
    display: block;
    margin-bottom: 10px;
    font-size: 11px;
    letter-spacing: 1.8px;
    font-weight: 800;
    color: #666;
    text-transform: uppercase;
}

/* Conte√∫do din√¢mico */
#timerDisplay {
    margin-top: 6px;
    font-size: 14px;
    color: #333;
}

#timerDisplay b {
    display: block;
    font-size: 18px;
    font-weight: 900;
    margin-bottom: 6px;
    color: var(--azul-marinho);
}

#timerDisplay span {
    display: inline-block;
    margin-top: 10px;
    font-size: 24px;
    font-weight: 800;
    letter-spacing: 0.5px;
}

/* Estados */
#prazoBox.estado-verde {
    border-color: var(--sucesso-verde);
    background: linear-gradient(180deg, #f1f8f4, #ffffff);
    animation: pulsoSuave 3s infinite;
}

#prazoBox.estado-verde #timerDisplay span {
    color: var(--sucesso-verde);
}

@keyframes pulsoSuave {
    0% { box-shadow: 0 0 0 rgba(46,125,50,0); }
    50% { box-shadow: 0 0 14px rgba(46,125,50,0.18); }
    100% { box-shadow: 0 0 0 rgba(46,125,50,0); }
}

/* Consulta fechada */
#consultaFechada {
    display: none;
    margin-top: 18px;
    border-top: 1px solid rgba(0,0,0,0.1);
    padding-top: 15px;
}

/* FORMUL√ÅRIO */
.form-group { margin-bottom: 20px; }

label {
    display: block;
    margin-bottom: 8px;
    font-weight: 700;
    color: #444;
    font-size: 13px;
    text-transform: uppercase;
}

.required::after {
    content: " *";
    color: var(--critico-vermelho);
}

input:not([type="radio"]) {
    width: 100%;
    padding: 14px;
    border: 1.5px solid #e1e4e8;
    border-radius: 8px;
    font-size: 16px;
    transition: var(--transicao);
}

input:focus {
    border-color: var(--azul-marinho);
    box-shadow: 0 0 0 3px rgba(26,60,110,0.1);
    outline: none;
}

/* BOT√ïES */
.btn {
    width: 100%;
    min-height: 52px;
    padding: 12px;
    border-radius: 8px;
    border: none;
    font-weight: 800;
    cursor: pointer;
    text-transform: uppercase;
    transition: var(--transicao);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.btn-primary {
    background: var(--azul-marinho);
    color: #fff;
    box-shadow: 0 4px 12px rgba(26,60,110,0.2);
}

.btn-primary:hover {
    background: var(--azul-hover);
    transform: translateY(-2px);
}

/* DARK MODE */
@media (prefers-color-scheme: dark) {
    body { background: #0f172a; color: #f1f5f9; }
    .container { background: #1e293b; border: 1px solid #334155; }
    #prazoBox { background: rgba(0,0,0,0.25); border-color: #334155; }
}
</style>

</head>
<body>

    <div class="container">
        <div id="barraProgresso"></div>
        <header class="header">
            <div class="logos">
                <img src="https://rondonia.ro.gov.br/wp-content/uploads/2024/09/Brasao-PMRO-370x523.png" alt="Bras√£o PMRO">
                <img src="https://museu.pm.ro.gov.br/wp-content/uploads/2024/05/1-bpm-3.png" alt="Logotipo 1¬∫ BPM">
            </div>
            <h2>DERSO 1¬∫ BPM</h2>
            <div class="divisor"></div>
            <p class="subtitle">Formul√°rio de Solicita√ß√£o de Di√°ria Especial de Refor√ßo do Servi√ßo Operacional</p>
        </header>

        <div id="loadingScreen" style="text-align: center; padding: 50px 0;">
            <p>Sincronizando dados com o sistema...</p>
        </div>

        <div id="formContent" class="is-hidden">
          <section id="prazoBox">
    <strong class="prazoTitulo">
        STATUS DO SISTEMA
    </strong>

    <div id="timerDisplay">
        ‚åõ CALCULANDO PRAZO...
    </div>
    
    <div id="consultaFechada">
        <input 
            type="text" 
            id="matriculaConsulta" 
            placeholder="Matr√≠cula p/ consulta" 
            inputmode="numeric"
        >
        <button 
            type="button" 
            class="btn btn-outline" 
            id="btnHistoryFechado"
        >
            üìÇ VER MINHAS SOLICITA√á√ïES
        </button>
    </div>
</section>


            <div id="instMessage"></div>

            <form id="dersoForm">
                <div class="form-group">
                    <label for="email" class="required">E-mail Institucional ou Pessoal:</label>
                    <input type="email" id="email" name="email" list="emailProviders" placeholder="exemplo@pm.ro.gov.br" required>
                    <datalist id="emailProviders"></datalist>
                    <span id="erroEmail" class="msg-erro">E-mail inv√°lido</span>
                </div>

                <div class="form-group">
                    <label for="matricula" class="required">Matr√≠cula (apenas n√∫meros):</label>
                    <input type="text" id="matricula" name="matricula" inputmode="numeric" placeholder="Ex: 100012345" required>
                    <span id="erroMatricula" class="msg-erro">‚ö†Ô∏è MATR√çCULA N√ÉO LOCALIZADA</span>
                </div>

                <div class="form-group">
                    <label for="nome">Nome Completo:</label>
                    <input type="text" id="nome" name="nome" readonly placeholder="Identifica√ß√£o autom√°tica">
                </div>

                <div class="form-group">
                    <label class="required">Tipo de Folga:</label>
                    <div class="radio-group" id="radioFolga">
                        <input type="radio" id="f24" name="folga" value="24H" required><label for="f24">24H</label>
                        <input type="radio" id="f48" name="folga" value="48H"><label for="f48">48H</label>
                        <input type="radio" id="f72" name="folga" value="72H"><label for="f72">72H</label>
                        <input type="radio" id="f96" name="folga" value="96H"><label for="f96">96H</label>
                        <input type="radio" id="fLE" name="folga" value="FOLGA LE"><label for="fLE">FOLGA LE</label>
                        <input type="radio" id="f1" name="folga" value="1¬™ Folga"><label for="f1">1¬™ FOLGA</label>
                        <input type="radio" id="f2" name="folga" value="2¬™ Folga"><label for="f2">2¬™ FOLGA</label>
                        <input type="radio" id="fExp" name="folga" value="Expediente"><label for="fExp">EXPEDIENTE</label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="data" class="required">Data da Folga:</label>
                    <input type="date" id="data" name="data" required>
                </div>

                <button type="button" class="btn btn-outline" id="btnHistory" style="margin-bottom:10px;">üìÇ VER MINHAS SOLICITA√á√ïES</button>
                <button type="submit" class="btn btn-primary" id="btnEnviar">ENVIAR SOLICITA√á√ÉO</button>
            </form>
        </div>

        <footer class="footer" id="footerText"></footer>
    </div>

    <div id="modalMsg" class="modal">
        <div class="modal-content">
            <div id="modalIcon" style="font-size: 50px;"></div>
            <h3 id="modalTitle"></h3>
            <p id="modalText"></p>
            <div id="historyContent"></div> 
            <button class="btn btn-primary" id="btnCloseModal">FECHAR</button>
        </div>
    </div>

<script>
    const CONFIG = {
        API_URL: "https://script.google.com/macros/s/AKfycbydNKKdRg-4TipeHqTYXNbJYTGiVZ899pGWzBQy4-AwnNV3PmmYOgZt8UW2BhmF6UVvyg/exec",
        VERSAO: "4.5.3",
        EMAIL_LIST: ["gmail.com","hotmail.com","outlook.com","yahoo.com","pm.ro.gov.br"],
        ADMIN_EMAIL: "1cia.rondon@gmail.com"
    };

    const STATE = { employeeList: {}, isClosed: false, sessionLogs: [] };
    
    // --- FUN√á√ÉO DE LOGS ---
    function registrarLog(acao, detalhes, tipo = "INFO") {
        const agora = new Date().toLocaleString("pt-BR");
        const logEntry = { data: agora, acao, detalhes, tipo };
        STATE.sessionLogs.push(logEntry);
        
        const cores = { INFO: "üîµ", SUCESSO: "üü¢", AVISO: "üü°", ERRO: "üî¥" };
        console.log(`${cores[tipo] || "‚ö™"} [${agora}] ${acao}:`, detalhes);
    }

    const DOM = {
        form: document.getElementById('dersoForm'),
        email: document.getElementById('email'),
        matricula: document.getElementById('matricula'),
        matriculaConsulta: document.getElementById('matriculaConsulta'),
        nome: document.getElementById('nome'),
        data: document.getElementById('data'),
        btnEnviar: document.getElementById('btnEnviar'),
        btnHistory: document.getElementById('btnHistory'),
        btnHistoryFechado: document.getElementById('btnHistoryFechado'),
        consultaFechada: document.getElementById('consultaFechada'),
        timerDisplay: document.getElementById('timerDisplay'),
        prazoBox: document.getElementById('prazoBox'),
        modal: document.getElementById('modalMsg'),
        historyContent: document.getElementById('historyContent'),
        loading: document.getElementById('loadingScreen'),
        formContent: document.getElementById('formContent'),
        barra: document.getElementById('barraProgresso'),
        footer: document.getElementById('footerText')
    };

    window.onload = async () => {
        registrarLog("SISTEMA", "Iniciando carregamento DERSO...");
        try {
            const [dResp, lResp] = await Promise.all([
                fetch(`${CONFIG.API_URL}?action=datas`).then(r => r.json()),
                fetch(`${CONFIG.API_URL}?action=lista`).then(r => r.json())
            ]);
            
            STATE.employeeList = lResp;
            DOM.loading.classList.add('is-hidden');
            DOM.formContent.classList.remove('is-hidden');
            
            registrarLog("SISTEMA", "Dados sincronizados com sucesso", "SUCESSO");
            
            applyInstitutionalTheme();
            monitorarPrazos(dResp.abertura, dResp.fechamento);
            setupEvents();
            updateFooter();
            applyDarkModeStyles(); // Aplica adapta√ß√µes de Modo Noturno
        } catch (e) {
            registrarLog("FALHA_CRITICA", e.message, "ERRO");
            console.error("‚ùå Erro de Conex√£o Inicial:", e);
            DOM.loading.innerHTML = "Falha cr√≠tica de comunica√ß√£o com o servidor.";
        }
    };

    // --- ADAPTA√á√ÉO DIN√ÇMICA MODO NOTURNO ---
    function applyDarkModeStyles() {
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            registrarLog("INTERFACE", "Modo Noturno detectado e aplicado");
            const style = document.createElement('style');
            style.innerHTML = `
                @media (prefers-color-scheme: dark) {
                    body { background-color: #121212; color: #e0e0e0; }
                    .container { background: #1e1e1e; border: 1px solid #333; }
                    input:not([type="radio"]), select, textarea { 
                        background: #2d2d2d !important; color: #fff !important; border-color: #444 !important; 
                    }
                    .radio-group label { background: #2d2d2d; border-color: #444; color: #eee; }
                    .subtitle { color: #bbb; }
                    #prazoBox { box-shadow: 0 4px 15px rgba(0,0,0,0.4); }
                }
            `;
            document.head.appendChild(style);
        }
    }

    function updateFooter() {
        const now = new Date();
        DOM.footer.textContent = `Desenvolvido na 1¬™ Cia do 1¬∫ BPM pelo PVSA Pedro Porto - vers√£o ${CONFIG.VERSAO} - em ${(now.getMonth() + 1).toString().padStart(2, '0')}/${now.getFullYear()}`;
    }

function monitorarPrazos(dataAbertura, dataFechamento) {
    const abertura = new Date(dataAbertura).getTime();
    const fechamento = new Date(dataFechamento).getTime();
    const hoje = new Date();
    
    // --- L√ìGICA DO M√äS SEGUINTE ---
    const mesSeguinte = hoje.getMonth() + 1;
    const ano = hoje.getFullYear();
    const dataMinima = new Date(ano, mesSeguinte, 1);
    const dataMaxima = new Date(ano, mesSeguinte + 1, 0); // √öltimo dia do m√™s seguinte
    
    // Formata√ß√£o para o atributo 'min' e 'max' (YYYY-MM-DD)
    const minStr = dataMinima.toISOString().split('T')[0];
    const maxStr = dataMaxima.toISOString().split('T')[0];
    
    DOM.data.min = minStr;
    DOM.data.max = maxStr;
    
    // ALTERA√á√ÉO PARA CELERIDADE: O campo inicia vazio para exibir dd/mm/aaaa
    DOM.data.value = ""; 

    // Adiciona o texto informativo abaixo da data
    let infoData = document.getElementById('infoPeriodo');
    if (!infoData) {
        infoData = document.createElement('small');
        infoData.id = 'infoPeriodo';
        infoData.style.display = 'block';
        infoData.style.marginTop = '5px';
        infoData.style.color = '#666';
        DOM.data.parentNode.appendChild(infoData);
    }
    infoData.innerHTML = `üìÖ Per√≠odo permitido: <b>${dataMinima.toLocaleDateString('pt-BR')}</b> a <b>${dataMaxima.toLocaleDateString('pt-BR')}</b>`;

    const nomeMesRef = dataMinima.toLocaleString('pt-BR', { month: 'long' }).toUpperCase();
    const ultimoDiaMes = dataMaxima.getTime();

    setInterval(() => {
        const agora = new Date().getTime();
        const instDiv = document.getElementById("instMessage");
        
        DOM.prazoBox.classList.remove('estado-verde', 'estado-alerta', 'estado-urgente', 'estado-critico', 'estado-sucesso', 'estado-inspecao');

        if (agora < abertura) {
            STATE.isClosed = true;
            DOM.form.style.display = "none";
            instDiv.style.display = "none";
            DOM.prazoBox.classList.add('estado-inspecao');
            
            const diff = abertura - agora;
            const d = Math.floor(diff / 86400000), h = Math.floor((diff % 86400000) / 3600000),
                  m = Math.floor((diff % 3600000) / 60000), s = Math.floor((diff % 60000) / 1000);
            
            DOM.timerDisplay.innerHTML = `
                <b style="color:#1A3C6E">ESTAMOS PASSANDO EM INSPE√á√ÉO AO C√ìDIGO.</b><br>
                <p style="margin: 10px 0;">Voltamos em: <br>
                <span style="font-size:1.1rem; font-weight:bold;">${d}d ${h}h ${m}m ${s}s</span></p>
                <span style="font-size:24px;">ü´°üëÆ‚Äç‚ôÇÔ∏è</span>`;
        } 
        else if (agora > fechamento) {
            STATE.isClosed = true;
            DOM.form.style.display = "none";
            instDiv.style.display = "none";
            
            if (agora <= ultimoDiaMes) {
                DOM.consultaFechada.style.display = "block";
                DOM.btnHistoryFechado.style.display = "block";
                DOM.prazoBox.classList.add('estado-sucesso');
                DOM.timerDisplay.innerHTML = `
                    <div style="padding:10px;">
                        <b style="color:#2E7D32">MISS√ÉO CUMPRIDA!</b><br>
                        <p style="font-size:14px; margin: 10px 0; line-height:1.4;">
                            AS SOLICITA√á√ïES DE DERSO PARA O M√äS DE <b>${nomeMesRef}</b> <br>
                            FORAM ENCERRADAS EM <b>${new Date(fechamento).toLocaleString("pt-BR")}</b>.
                        </p>
                        <p style="font-size:13px; color:#555;">Voc√™ ainda pode consultar suas solicita√ß√µes abaixo: üëÆ‚Äç‚ôÇÔ∏è</p>
                    </div>`;
            } else {
                DOM.consultaFechada.style.display = "none";
                DOM.timerDisplay.innerHTML = "‚åõ Aguardando novo cronograma de escalas...";
            }
        } 
        else {
            STATE.isClosed = false;
            DOM.form.style.display = "block";
            instDiv.style.display = "block";
            
            const diff = fechamento - agora;
            const d = Math.floor(diff / 86400000), h = Math.floor((diff % 86400000) / 3600000),
                  m = Math.floor((diff % 3600000) / 60000), s = Math.floor((diff % 60000) / 1000);

            // --- L√ìGICA DE URG√äNCIA ATUALIZADA ---
            if (diff < 7200000) { // Menos de 2 horas (CR√çTICO)
                DOM.prazoBox.classList.add('estado-critico');
                DOM.timerDisplay.innerHTML = `üî• <b>EMERG√äNCIA: TEMPO ACABANDO!</b><br>Fecha em: <b>${h}h ${m}m ${s}s</b>`;
            } else if (diff < 21600000) { // Menos de 6 horas (URGENTE)
                DOM.prazoBox.classList.add('estado-urgente');
                DOM.timerDisplay.innerHTML = `‚ö†Ô∏è <b>R√ÅPIDO! O TEMPO EST√Å ACABANDO</b><br>Resta apenas: <b>${h}h ${m}m ${s}s</b>`;
            } else if (diff < 86400000) { // Menos de 24 horas (ALERTA)
                DOM.prazoBox.classList.add('estado-alerta');
                DOM.timerDisplay.innerHTML = `‚è≥ <b>SISTEMA FECHA EM BREVE</b><br>Tempo restante: ${h}h ${m}m ${s}s`;
            } else { // VERDE
                DOM.prazoBox.classList.add('estado-verde');
                DOM.timerDisplay.innerHTML = `‚ö° <b>OPERACIONAL ATIVO</b><br><small>Encerra em: ${d}d ${h}h ${m}m ${s}s</small>`;
            }
        }
    }, 1000);
}
   
function applyInstitutionalTheme(matriculaLogada = null) {
    const hoje = new Date();
    const diaAtual = hoje.getDate();
    const mesAtual = hoje.getMonth();
    const chaveHoje = `${diaAtual}-${mesAtual + 1}`;
    
    // M√™s de refer√™ncia (M√™s seguinte para a escala)
    const dataRef = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 1);
    const mesReferencia = dataRef.getMonth(); 

    const instDiv = document.getElementById("instMessage");
    const aplicar = (msg) => instDiv.innerHTML = msg;

    // 1. PRIORIDADE M√ÅXIMA: Anivers√°rio do Combatente Logado
    if (matriculaLogada && STATE.employeeList[matriculaLogada]) {
        const militar = STATE.employeeList[matriculaLogada];
        if (militar.niver === chaveHoje) {
            const primeiroNome = (militar.nome || "").split(' ')[0];
            return aplicar(`üéÇ <b>Parab√©ns, ${primeiroNome}!</b> O 1¬∫ BPM celebra seu dia. Sa√∫de e vida longa, combatente! ü´°`);
        }
    }

    // 2. PRIORIDADE M√âDIA: Datas Comemorativas (Hoje)
    const temasPontuais = {
        "4-1": `üå≥ Rond√¥nia: ${hoje.getFullYear() - 1982} anos de hist√≥ria e bravura.`,
        "1-5": "üõ†Ô∏è Dia do Trabalhador: O servi√ßo p√∫blico move a cidadania.",
        "7-9": "üáßüá∑ 7 de Setembro: Independ√™ncia se constr√≥i com Ordem e Progresso.",
        "7-12": `üõ°Ô∏è 1¬∫ BPM: O Sentinela da Capital. ${hoje.getFullYear() - 1983} anos de compromisso.`
    };

    if (temasPontuais[chaveHoje]) {
        return aplicar(temasPontuais[chaveHoje]);
    }

    // 3. PADR√ÉO: Mensagem Mensal (Baseada no M√™s da Escala - M√™s Seguinte)
    const mensais = {
        0: "üé≠ Janeiro: Planejamento estrat√©gico para o novo ano.",
        1: "üéä Fevereiro: Foco e preven√ß√£o na seguran√ßa dos eventos.",
        2: "üå∑ Mar√ßo: Homenagem √†s mulheres que honram a farda.",
        3: "üïäÔ∏è Abril: Tempo de renova√ß√£o e fortalecimento da uni√£o.",
        4: "ü§± Maio: M√£es, a base de tudo. Reconhecemos sua miss√£o.",
        5: "üî• Junho: Valorizando a cultura e as tradi√ß√µes locais.",
        6: "üëÆ Julho: Disciplina e prontid√£o no policiamento ostensivo.",
        7: "üëî Agosto: A presen√ßa familiar √© o alicerce do profissional.",
        8: "üáßüá∑ Setembro: Renovando nosso juramento de servir e proteger.",
        9: "üéóÔ∏è Outubro: Preven√ß√£o √© o melhor caminho para a sa√∫de.",
        10: "üìú Novembro: Compromisso com os ideais da Rep√∫blica.",
        11: "üéÑ Dezembro: Planejamento garante um final de ano seguro. ‚ú®"
    };

    aplicar(mensais[mesReferencia] || "DERSO 1¬∫ BPM");
}

    function setupEvents() {
        DOM.email.oninput = (e) => {
    const val = e.target.value;
    const datalist = document.getElementById('emailProviders');
    datalist.innerHTML = "";

    if (val.includes("@")) {
        const prefix = val.split("@")[0];
        CONFIG.EMAIL_LIST.forEach(p => {
            datalist.innerHTML += `<option value="${prefix}@${p}">`;
        });
    }

    // ‚úÖ FEEDBACK VISUAL DE VALIDA√á√ÉO
    DOM.email.classList.toggle(
        "valido",
        /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val)
    );

    updateProgress();
};

        DOM.matricula.onblur = () => {
            let val = DOM.matricula.value.trim();
            if (!val) return;
            if (val.length <= 6 && !val.startsWith("1000")) val = "1000" + val;
            DOM.matricula.value = val;
            
            if (STATE.employeeList[val]) {
                const militar = STATE.employeeList[val];
                DOM.nome.value = typeof militar === 'object' ? militar.nome : militar;
                document.getElementById('erroMatricula').style.display = "none";
                registrarLog("VALIDACAO", `Matr√≠cula ${val} identificada`, "SUCESSO");
                
                // Dispara o tema institucional com a matr√≠cula logada
                applyInstitutionalTheme(val);
            } else {
                DOM.nome.value = "";
                document.getElementById('erroMatricula').style.display = "block";
                registrarLog("VALIDACAO", `Matr√≠cula ${val} n√£o encontrada`, "AVISO");
                applyInstitutionalTheme(); // Volta ao tema padr√£o
            }
            updateProgress();
        };

        DOM.form.oninput = updateProgress;
        DOM.btnHistory.onclick = () => fetchHistory(DOM.matricula.value);
        DOM.btnHistoryFechado.onclick = () => fetchHistory(DOM.matriculaConsulta.value);
        document.getElementById('btnCloseModal').onclick = () => DOM.modal.style.display = 'none';
        DOM.form.onsubmit = handleSubmit;
    }

    function updateProgress() {
        const fields = [
            /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(DOM.email.value),
            DOM.nome.value.length > 3,
            !!document.querySelector('input[name="folga"]:checked'),
            DOM.data.value !== ""
        ];
        const perc = (fields.filter(Boolean).length / 4) * 100;
        DOM.barra.style.width = perc + "%";
        DOM.barra.classList.toggle('barra-completa', perc === 100);
    }

    async function fetchHistory(mat) {
        if (!mat) {
            registrarLog("PESQUISA", "Tentativa de consulta sem matr√≠cula", "AVISO");
            return showModal("AVISO", "Insira a matr√≠cula para consultar.", "üìÇ", "#FFD700");
        }
        registrarLog("PESQUISA", `Buscando hist√≥rico para: ${mat}`);
        showModal("CONSULTANDO", "Buscando seus registros...", "‚è≥", "#1A3C6E");
        try {
            const r = await fetch(`${CONFIG.API_URL}?action=historico&matricula=${mat}`).then(res => res.json());
            if (r.dados && r.dados.length > 0) {
                registrarLog("PESQUISA", `${r.dados.length} registros encontrados para ${mat}`, "SUCESSO");
                const html = r.dados.map(i => `<div class="historico-item"><span>üìÖ ${i.data}</span><b>${i.folga}</b></div>`).join('');
                DOM.historyContent.innerHTML = html;
                showModal(r.nome || "REGISTROS", "Solicita√ß√µes encontradas:", "üìã", "#1A3C6E", true);
            } else {
                registrarLog("PESQUISA", `Nenhum registro encontrado para ${mat}`, "INFO");
                showModal("NADA ENCONTRADO", "N√£o h√° registros para esta matr√≠cula.", "üîé", "#777");
            }
        } catch (e) {
            registrarLog("PESQUISA_FALHA", e.message, "ERRO");
            showModal("ERRO", "Falha na comunica√ß√£o com o banco de dados.", "‚ùå", "red");
        }
    }

    async function handleSubmit(e) {
    e.preventDefault();
    DOM.btnEnviar.disabled = true;
    DOM.btnEnviar.textContent = "ENVIANDO...";
    
    const mLog = DOM.matricula.value;
    registrarLog("ENVIO", `Iniciando tentativa de envio para matr√≠cula: ${mLog}`);

    try {
        const formData = new URLSearchParams(new FormData(DOM.form));
        const response = await fetch(CONFIG.API_URL, { method: 'POST', body: formData }).then(r => r.json());

        if (response.success) {
            registrarLog("ENVIO", `Solicita√ß√£o de ${mLog} gravada com sucesso`, "SUCESSO");
            showModal("SUCESSO!", "Sua solicita√ß√£o foi registrada no banco de dados.", "‚úî", "#2E7D32");
            
            // --- ALTERA√á√ÉO PARA CELERIDADE: RESET SELETIVO ---
            DOM.data.value = ""; // Limpa a data
            document.querySelectorAll('input[name="folga"]').forEach(radio => radio.checked = false); // Desmarca a folga
            
            updateProgress();
        } else {
            registrarLog("ENVIO_NEGADO", `Servidor recusou: ${response.message}`, "AVISO");
            if (response.message.includes("duplicada")) {
                showModal("SOLICITA√á√ÉO DUPLICADA", "Voc√™ j√° solicitou folga para esta data.", "üö´", "orange");
                
                // Limpa apenas a data e folga tamb√©m em caso de duplicidade para ele tentar outra
                DOM.data.value = "";
                document.querySelectorAll('input[name="folga"]').forEach(radio => radio.checked = false);
                updateProgress();
            } else {
                showModal("AVISO", response.message, "‚ö†Ô∏è", "orange");
            }
        }
    } catch (err) {
        registrarLog("ENVIO_CRITICO", err.message, "ERRO");
        showModal("ERRO DE CONEX√ÉO", "N√£o foi poss√≠vel enviar sua solicita√ß√£o. Verifique sua internet.", "üì°", "red");
    } finally {
        DOM.btnEnviar.disabled = false;
        DOM.btnEnviar.textContent = "ENVIAR SOLICITA√á√ÉO";
    }
}

    function showModal(title, text, icon, color, showHistory = false) {
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalText').textContent = text;
        const iconDiv = document.getElementById('modalIcon');
        iconDiv.textContent = icon;
        iconDiv.style.color = color;
        DOM.historyContent.classList.toggle('is-hidden', !showHistory);
        DOM.modal.style.display = 'flex';
    }
</script>
</body>
</html>

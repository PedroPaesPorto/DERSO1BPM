<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicita√ß√£o de Folga - DERSO (Otimizada)</title>

    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root{
            --azul-marinho:#0C3667;
            --dourado:#C9A400; /* escurecido para contraste */
            --azul-hover:#1a5ca7;
            --erro:#b00020;
            --sucesso:#388e3c;
            --cinza-fundo:#f4f7f9;
            --cinza-texto:#222;
            --borda:#bdbdbd;
        }
        *{box-sizing:border-box}
        body{margin:0;font-family:'Roboto',Arial,Helvetica,sans-serif;background:var(--cinza-fundo);color:var(--cinza-texto);display:flex;justify-content:center;align-items:flex-start;padding:24px}
        .container{width:100%;max-width:720px;background:#fff;border-radius:10px;padding:22px 24px;box-shadow:0 10px 30px rgba(0,0,0,.12);position:relative}
        #progressBarContainer{position:absolute;left:0;top:0;width:100%;height:6px;background:#e6e9ee;border-radius:10px;overflow:hidden}
        #progressBar{height:100%;width:0;background:linear-gradient(90deg,var(--dourado),var(--azul-marinho));transition:width .35s ease}
        header{display:flex;gap:14px;align-items:center;margin-bottom:12px}
        .logos{display:flex;gap:12px;align-items:center}
        .logos img{height:54px;object-fit:contain;display:block}
        h1{font-family:'Merriweather',serif;color:var(--azul-marinho);font-size:20px;margin:0}
        .subtitle{font-size:14px;color:#444;margin-top:6px}
        form{margin-top:14px}
        fieldset{border:1px solid var(--borda);padding:12px;border-radius:8px;margin-bottom:16px}
        legend{font-weight:600;padding:0 6px}
        .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        label{display:block;font-size:13px;margin-bottom:6px}
        input[type=text],input[type=email],input[type=date],select{width:100%;padding:10px;border:1px solid var(--borda);border-radius:6px;font-size:14px}
        input[readonly]{background:#f1f3f5}
        .small{font-size:12px;color:#666}
        .radio-group-buttons{display:flex;flex-wrap:wrap;gap:8px}
        .radio-button{padding:8px 10px;border:1px solid var(--borda);border-radius:6px;cursor:pointer;font-weight:600;font-size:13px}
        .radio-button[aria-checked="true"]{background:var(--azul-marinho);color:var(--dourado);border-color:var(--azul-marinho)}
        .error{color:var(--erro);font-size:13px;margin-top:6px}
        .info-message{display:none;padding:12px;border-left:4px solid;border-radius:6px;margin-bottom:12px}
        .info-message.success{background:#e8f5e9;color:var(--sucesso);border-left-color:var(--sucesso)}
        .info-message.error{background:#fff0f2;color:var(--erro);border-left-color:var(--erro)}
        .actions{display:flex;gap:10px}
        .button{flex:1;padding:12px 14px;border-radius:8px;border:none;background:var(--azul-hover);color:#fff;font-weight:700;cursor:pointer;text-transform:uppercase}
        .button.secondary{background:#fff;border:1px solid var(--borda);color:var(--cinza-texto);text-transform:none}
        #loadingOverlay{position:fixed;top:0;left:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(255,255,255,.85);z-index:9999}
        .spinner{width:30px;height:30px;border-radius:50%;border:4px solid rgba(0,0,0,.08);border-top:4px solid var(--azul-hover);animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .field-with-spinner{position:relative}
        .field-with-spinner .mini-spinner{position:absolute;right:8px;top:50%;transform:translateY(-50%);width:18px;height:18px;border-radius:50%;border:3px solid rgba(0,0,0,.08);border-top:3px solid var(--azul-hover);animation:spin .8s linear infinite;display:none}
        .is-loading .mini-spinner{display:block}
        .footer{font-size:12px;color:#666;text-align:center;margin-top:8px}
        @media(max-width:640px){.grid{grid-template-columns:1fr}.logos img{height:44px}.container{padding:18px}}
    </style>
</head>
<body>

<div id="loadingOverlay" role="status" aria-live="polite"><div style="text-align:center"><div class="spinner"></div><div style="margin-top:10px;color:var(--azul-marinho)">Enviando...</div></div></div>

<div class="container" id="app">
    <div id="progressBarContainer"><div id="progressBar" aria-hidden="true"></div></div>

    <header>
        <div class="logos">
            <img src="https://rondonia.ro.gov.br/wp-content/uploads/2024/09/Brasao-PMRO-370x523.png" alt="Bras√£o PMRO" loading="lazy">
            <img src="https://museu.pm.ro.gov.br/wp-content/uploads/2024/05/1-bpm-3.png" alt="1¬∫ BPM" loading="lazy">
        </div>
        <div style="flex:1">
            <h1>DERSO ‚Äî 1¬∫ BPM</h1>
            <div class="subtitle">Solicita√ß√£o de Di√°ria Especial de Refor√ßo do Servi√ßo Operacional</div>
        </div>
    </header>

    <div id="prazoMessage" class="info-message" role="status" aria-live="polite"></div>

    <div id="initialLoading" style="text-align:center;padding:26px;color:var(--azul-marinho)">
        <div class="spinner" style="width:36px;height:36px;border-width:5px"></div>
        <div style="margin-top:10px">Carregando dados do sistema...</div>
    </div>

    <form id="dersoForm" style="display:none" aria-labelledby="formTitle">
        <fieldset aria-labelledby="idTitle">
            <legend id="idTitle">Identifica√ß√£o</legend>
            <div class="grid">
                <div>
                    <label for="email">E-mail</label>
                    <input type="email" id="email" name="email" list="emailProviders" autocomplete="email" aria-describedby="emailHelp">
                    <datalist id="emailProviders"></datalist>
                    <div id="emailHelp" class="small">Use seu e-mail institucional ou pessoal.</div>
                </div>
                <div>
                    <label for="matricula">Matr√≠cula</label>
                    <div class="field-with-spinner" id="matBlock">
                        <input type="text" id="matricula" name="matricula" inputmode="numeric" pattern="\d*" required placeholder="Ex: 100012345" aria-describedby="matError">
                        <div class="mini-spinner" id="matSpinner" aria-hidden="true"></div>
                    </div>
                    <div id="matError" class="small error" aria-live="polite"></div>
                </div>
                <div>
                    <label for="nome">Nome</label>
                    <input type="text" id="nome" name="nome" readonly aria-readonly="true">
                </div>
                <div>
                    <label for="data">Data</label>
                    <input type="date" id="data" name="data" required aria-describedby="dateHelp">
                    <div id="dateHelp" class="small"></div>
                </div>
            </div>
        </fieldset>

        <fieldset role="radiogroup" aria-label="Tipo de Folga">
            <legend>Tipo de Folga</legend>
            <div class="radio-group-buttons" id="folgaGroup">
                <!-- Buttons will be generated by JS for accessibility -->
            </div>
            <div id="duplicateError" class="error" aria-live="polite"></div>
        </fieldset>

        <div style="display:flex;gap:10px;align-items:center;margin-top:8px;margin-bottom:6px">
            <button type="button" class="button secondary" id="btnPreview">Visualizar resumo</button>
            <button type="submit" class="button" id="btnSubmit">Enviar Solicita√ß√£o</button>
        </div>

    </form>

    <div id="statusMessage" class="info-message" role="status" aria-live="polite"></div>

    <div class="footer" id="footerText"></div>
</div>

<!-- Modal de confirma√ß√£o simples -->
<div id="confirmModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);align-items:center;justify-content:center;z-index:9998">
    <div style="background:#fff;padding:18px;border-radius:10px;max-width:520px;width:92%">
        <h3 style="margin:0 0 8px 0;color:var(--azul-marinho)">Confirme sua Solicita√ß√£o</h3>
        <div id="summaryBox" style="font-size:14px;color:#333;margin-bottom:12px"></div>
        <div style="display:flex;gap:8px">
            <button id="confirmSend" class="button">Confirmar e Enviar</button>
            <button id="cancelSend" class="button secondary">Voltar</button>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwe2vseE23YEgIwPxOHiXlv3COUfJYVRsMSTYov0v78zSgDZtOeTCYx1J8GOzlzKhwDFg/exec";
    const emailProviders = ["gmail.com","hotmail.com","outlook.com","yahoo.com","terra.com.br","bol.com.br","pm.ro.gov.br"]; // incluiu dom√≠nio institucional

    // estado global simples
    window.employeeList = {};

    const progressBar = document.getElementById('progressBar');
    const initialLoading = document.getElementById('initialLoading');
    const formEl = document.getElementById('dersoForm');
    const statusMessage = document.getElementById('statusMessage');
    const prazoMessage = document.getElementById('prazoMessage');
    const matSpinner = document.getElementById('matSpinner');

    function setProgress(p){ progressBar.style.width = p + '%'; }

    // fetch com timeout e retries
    async function fetchWithTimeout(url, opts = {}, timeout = 8000){
        const controller = new AbortController();
        const id = setTimeout(()=>controller.abort(), timeout);
        try{
            const res = await fetch(url, {...opts, signal: controller.signal});
            clearTimeout(id);
            return res;
        }catch(e){ clearTimeout(id); throw e; }
    }

    // debounce helper
    function debounce(fn, wait){ let t; return function(...a){ clearTimeout(t); t = setTimeout(()=>fn.apply(this,a), wait); }; }

    function setDateLimits(){
        const dateInput = document.getElementById('data');
        const dateHelp = document.getElementById('dateHelp');
        const today = new Date();
        const start = new Date(today.getFullYear(), today.getMonth()+1, 1);
        const end = new Date(today.getFullYear(), today.getMonth()+2, 0);
        dateInput.min = start.toISOString().split('T')[0];
        dateInput.max = end.toISOString().split('T')[0];
        dateHelp.textContent = `Per√≠odo permitido: ${start.toLocaleDateString('pt-BR')} ‚Äî ${end.toLocaleDateString('pt-BR')}`;
    }

    function standardizeMatricula(m){
        if(!m) return '';
        let num = m.replace(/\D/g,'').slice(-9); // pega at√© 9 digitos finais
        if(!num) return '';
        return num.startsWith('1000') ? num : '1000' + num.slice(-5); // tenta formar 9 d√≠gitos
    }

    // popula bot√µes de folga dinamicamente (acess√≠vel)
    const folgas = ['24H','48H','72H','96H','FOLGA LE','1¬™ FOLGA','2¬™ FOLGA','EXPEDIENTE'];
    function renderFolgas(){
        const g = document.getElementById('folgaGroup');
        g.innerHTML = '';
        folgas.forEach((f, i)=>{
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'radio-button';
            btn.setAttribute('role','radio');
            btn.setAttribute('aria-checked','false');
            btn.textContent = f;
            btn.dataset.value = f;
            btn.addEventListener('click', ()=>{
                [...g.querySelectorAll('[role="radio"]')].forEach(b=>b.setAttribute('aria-checked','false'));
                btn.setAttribute('aria-checked','true');
            });
            g.appendChild(btn);
        });
    }

    // atualizar datalist de e-mails
    function updateEmailDatalist(){
        const input = document.getElementById('email');
        const dl = document.getElementById('emailProviders');
        const val = input.value || '';
        const idx = val.indexOf('@');
        dl.innerHTML = '';
        let username = val;
        if(idx >= 0) username = val.slice(0, idx+1);
        const fragment = document.createDocumentFragment();
        emailProviders.forEach(d => {
            if(!val || idx === -1 || d.startsWith(val.slice(idx+1).toLowerCase())){
                const option = document.createElement('option');
                option.value = username + d;
                fragment.appendChild(option);
            }
        });
        dl.appendChild(fragment);
    }

    // Carrega lista de funcion√°rios
    async function loadEmployeeList(){
        setProgress(10);
        const mat = document.getElementById('matricula');
        mat.disabled = true;
        document.getElementById('matError').textContent = '';
        try{
            const res = await fetchWithTimeout(SCRIPT_URL+'?action=lista', {}, 9000);
            const data = await res.json();
            if(data.error) throw new Error(data.error);
            window.employeeList = data;
            mat.disabled = false;
            setProgress(30);
        }catch(e){
            document.getElementById('matError').textContent = 'Erro ao carregar lista de funcion√°rios.';
            showPersistentMessage('‚ö†Ô∏è Erro ao carregar dados. Recarregue a p√°gina ou contate o suporte.','error');
            initialLoading.style.display = 'none';
            formEl.style.display = 'none';
            console.error(e);
        }
    }

    // verifica matr√≠cula (n√£o chama se vazio)
    async function checkMatricula(){
        const m = document.getElementById('matricula');
        const n = document.getElementById('nome');
        const e = document.getElementById('matError');
        e.textContent = '';
        n.value = '';
        const raw = m.value.trim();
        if(!raw) { m.classList.remove('is-invalid','is-valid'); return; }
        const standardized = standardizeMatricula(raw);
        if(!standardized){ e.textContent = 'Matr√≠cula inv√°lida.'; m.classList.add('is-invalid'); return; }
        m.value = standardized;

        // show spinner
        document.getElementById('matBlock').classList.add('is-loading');
        matSpinner.style.display = 'block';

        // Simples lookup local primeiro
        if(window.employeeList && window.employeeList[standardized]){
            n.value = window.employeeList[standardized];
            m.classList.remove('is-invalid'); m.classList.add('is-valid');
            matSpinner.style.display = 'none';
            document.getElementById('matBlock').classList.remove('is-loading');
            return;
        }

        // fallback: requisitar ao endpoint (caso exista)
        try{
            const res = await fetchWithTimeout(SCRIPT_URL+`?action=lookup&matricula=${standardized}`,{},7000);
            const d = await res.json();
            if(d && d.nome){
                n.value = d.nome;
                m.classList.add('is-valid');
            } else {
                e.textContent = 'Matr√≠cula n√£o encontrada.';
                m.classList.add('is-invalid');
            }
        }catch(err){
            console.warn('lookup falhou',err);
            e.textContent = 'Erro ao validar matr√≠cula. Tente novamente.';
            m.classList.add('is-invalid');
        }finally{
            matSpinner.style.display = 'none';
            document.getElementById('matBlock').classList.remove('is-loading');
        }
    }

    const debouncedCheckMatricula = debounce(checkMatricula, 350);

    // verifica duplicidade
    async function checkDuplicity(matricula, dataBR, folga){
        setProgress(70);
        try{
            const url = `${SCRIPT_URL}?action=check_duplicidade&matricula=${encodeURIComponent(matricula)}&data=${encodeURIComponent(dataBR)}&folga=${encodeURIComponent(folga)}`;
            const res = await fetchWithTimeout(url,{},7000);
            const j = await res.json();
            return j.duplicado === true;
        }catch(e){
            console.error('Falha duplicidade',e);
            showMessage('‚ö†Ô∏è N√£o foi poss√≠vel verificar duplicidade. Tentando prosseguir...','error');
            return false; // deixa o envio prosseguir ‚Äî servidor far√° valida√ß√£o final
        }
    }

    // form submit
    async function submitForm(e){
        e.preventDefault();
        const btn = document.getElementById('btnSubmit');
        const matriculaInput = document.getElementById('matricula');
        const nomeVal = document.getElementById('nome').value.trim();
        const dataVal = document.getElementById('data').value;
        const folgaBtn = document.querySelector('#folgaGroup [aria-checked="true"]');
        const duplicateError = document.getElementById('duplicateError');
        duplicateError.textContent = '';

        if(!folgaBtn){ duplicateError.textContent = 'Selecione um tipo de folga.'; return; }
        if(!nomeVal || matriculaInput.classList.contains('is-invalid')){ document.getElementById('matError').textContent = 'Verifique a matr√≠cula.'; return; }
        if(!dataVal){ document.getElementById('dateHelp').textContent = 'Escolha uma data v√°lida.'; return; }

        // resumo e confirma√ß√£o modal
        const summary = {
            matricula: matriculaInput.value,
            nome: nomeVal,
            email: document.getElementById('email').value,
            data: formatBR(dataVal),
            folga: folgaBtn.dataset.value
        };
        showSummaryModal(summary);
    }

    // envia depois de confirmado
    async function confirmAndSend(summary){
        try{
            document.getElementById('confirmModal').style.display = 'none';
            document.getElementById('loadingOverlay').style.display = 'flex';
            setProgress(80);
            const isDup = await checkDuplicity(summary.matricula, summary.data, summary.folga);
            if(isDup){ showMessage(`‚ö†Ô∏è Solicita√ß√£o DUPLICADA para ${summary.data} ‚Äî ${summary.folga}`,'error'); return; }

            // prepara envio
            const payload = new URLSearchParams();
            payload.set('matricula', summary.matricula);
            payload.set('nome', summary.nome);
            payload.set('email', summary.email);
            payload.set('data', summary.data);
            payload.set('folga', summary.folga);

            const res = await fetchWithTimeout(SCRIPT_URL, {method:'POST', body: payload}, 10000);
            const j = await res.json();
            if(j && j.success){
                showMessage('‚úÖ Solicita√ß√£o enviada com sucesso. Verifique seu e-mail.','success');
                formEl.reset();
                document.getElementById('nome').value = '';
                // salvar √∫ltimo uso
                try{ localStorage.setItem('derso_lastEmail', summary.email || ''); localStorage.setItem('derso_lastMat', summary.matricula); }catch(e){}
            } else {
                showMessage('‚ö†Ô∏è Erro ao enviar: '+(j.error || 'Tente novamente.'),'error');
            }
        }catch(e){
            console.error(e);
            showMessage('‚ö†Ô∏è Falha na conex√£o. Tente novamente.','error');
        }finally{
            document.getElementById('loadingOverlay').style.display = 'none';
            setProgress(100);
            setTimeout(()=>setProgress(0),1200);
        }
    }

    // auxiliares
    function formatBR(iso){ if(!iso) return ''; const [y,m,d] = iso.split('-'); return `${d}/${m}/${y}`; }

    function showMessage(msg,type='success'){
        const d = statusMessage; d.className = 'info-message '+(type==='success'?'success':'error'); d.innerHTML = msg; d.style.display = 'block';
        setTimeout(()=>{ d.style.display = 'none'; },6000);
    }
    function showPersistentMessage(msg,type='success'){ prazoMessage.className = 'info-message '+(type==='success'?'success':'error'); prazoMessage.innerHTML = msg; prazoMessage.style.display = 'block'; }

    // modal
    function showSummaryModal(summary){
        const box = document.getElementById('summaryBox');
        box.innerHTML = `<div><strong>Nome:</strong> ${summary.nome}</div><div><strong>Matr√≠cula:</strong> ${summary.matricula}</div><div><strong>Folga:</strong> ${summary.folga}</div><div><strong>Data:</strong> ${summary.data}</div><div style=\"margin-top:8px;font-size:13px;color:#666\">E-mail: ${summary.email||'---'}</div>`;
        const modal = document.getElementById('confirmModal'); modal.style.display = 'flex';
        document.getElementById('confirmSend').onclick = ()=>confirmAndSend(summary);
        document.getElementById('cancelSend').onclick = ()=>modal.style.display = 'none';
    }

    // checa duplicidade e datas iniciais
    async function initializeForm(){
        setProgress(5);
        renderFolgas();
        updateEmailDatalist();
        setDateLimits();
        await loadEmployeeList();
        setProgress(40);

        // verifica per√≠odo aberto (datas fornecidas pelo script)
        try{
            const res = await fetchWithTimeout(SCRIPT_URL+'?action=datas',{},7000);
            const d = await res.json();
            if(d.error){ throw new Error(d.error); }
            const now = new Date();
            const abertura = new Date(d.abertura);
            const fechamento = new Date(d.fechamento);
            initialLoading.style.display = 'none';
            if(now < abertura){ showPersistentMessage(`‚è≥ Abertura em ${abertura.toLocaleString('pt-BR')}`,'error'); formEl.style.display = 'none'; }
            else if(now > fechamento){ showPersistentMessage(`‚õî Encerrado em ${fechamento.toLocaleString('pt-BR')}`,'error'); formEl.style.display = 'none'; }
            else{ // aberto
                formEl.style.display = 'block';
                const diffDays = Math.ceil((fechamento - now)/(1000*60*60*24));
                showPersistentMessage(`üö® Restam ${diffDays} dia(s) ‚Äî fechamento: ${fechamento.toLocaleString('pt-BR')}`,'success');
            }
        }catch(err){
            console.warn(err);
            showPersistentMessage('‚ö†Ô∏è Falha ao obter prazo. Verifique a conex√£o.','error');
            initialLoading.style.display = 'none';
            formEl.style.display = 'none';
        }

        // try to restore last used values
        try{ const lastEmail = localStorage.getItem('derso_lastEmail'); if(lastEmail) document.getElementById('email').value = lastEmail; }catch(e){}

        const now = new Date(); const mes = String(now.getMonth()+1).padStart(2,'0'); const ano = now.getFullYear();
        document.getElementById('footerText').textContent = `Desenvolvido na 1¬™ Cia do 1¬∫ BPM ‚Äî PVSA Pedro Porto ‚Äî ${mes}/${ano}`;
        setProgress(60);
    }

    // impede submit por Enter em inputs (exceto quando bot√£o)
    document.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter' && e.target && (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT')){
            e.preventDefault();
        }
    });

    // listeners
    document.addEventListener('DOMContentLoaded', ()=>{
        initializeForm();
        document.getElementById('matricula').addEventListener('input', debouncedCheckMatricula);
        document.getElementById('email').addEventListener('input', updateEmailDatalist);
        document.getElementById('dersoForm').addEventListener('submit', submitForm);
        document.getElementById('btnPreview').addEventListener('click', ()=>{
            const m = document.getElementById('matricula').value; const n = document.getElementById('nome').value; const email = document.getElementById('email').value; const data = document.getElementById('data').value; const folga = document.querySelector('#folgaGroup [aria-checked="true"]');
            if(!m || !n || !data || !folga){ showMessage('Preencha matr√≠cula, nome, data e tipo de folga para visualizar.','error'); return; }
            showSummaryModal({matricula:m,nome:n,email, data:formatBR(data), folga:folga.dataset.value});
        });
    });

    // prote√ß√£o extra: evita m√∫ltiplos envios r√°pidos
    (function disableDoubleClickOnSubmit(){
        const btn = document.getElementById('btnSubmit');
        btn.addEventListener('click', ()=>{ btn.disabled = true; setTimeout(()=>btn.disabled=false,4000); });
    })();

</script>
</body>
</html>

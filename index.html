<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicita√ß√£o de Folga - DERSO (Otimizada)</title>

    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root{
            --azul-marinho:#0C3667;
            --dourado:#C9A400; /* escurecido para contraste */
            --azul-hover:#1a5ca7;
            --erro:#b00020;
            --alerta-prazo:#D36400; /* Laranja para prazo apertado */
            --sucesso:#388e3c;
            --cinza-fundo:#f4f7f9;
            --cinza-texto:#222;
            --borda:#bdbdbd;
            --padding-md: 12px;
            --font-size-sm: 13px;
        }
        *{box-sizing:border-box}
        body{margin:0;font-family:'Roboto',Arial,Helvetica,sans-serif;background:var(--cinza-fundo);color:var(--cinza-texto);display:flex;justify-content:center;align-items:flex-start;padding:24px}
        .container{width:100%;max-width:720px;background:#fff;border-radius:10px;padding:22px 24px;box-shadow:0 10px 30px rgba(0,0,0,.12);position:relative}
        #progressBarContainer{position:absolute;left:0;top:0;width:100%;height:6px;background:#e6e9ee;border-radius:10px;overflow:hidden}
        #progressBar{height:100%;width:0;background:linear-gradient(90deg,var(--dourado),var(--azul-marinho));transition:width .35s ease}
        header{display:flex;gap:14px;align-items:center;margin-bottom:12px}
        .logos{display:flex;gap:12px;align-items:center}
        .logos img{height:54px;object-fit:contain;display:block}
        h1{font-family:'Merriweather',serif;color:var(--azul-marinho);font-size:20px;margin:0}
        .subtitle{font-size:14px;color:#444;margin-top:6px}
        form{margin-top:14px}
        fieldset{border:1px solid var(--borda);padding:var(--padding-md);border-radius:8px;margin-bottom:16px}
        legend{font-weight:600;padding:0 6px}
        .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        label{display:block;font-size:var(--font-size-sm);margin-bottom:6px}
        input[type=text],input[type=email],input[type=date],select{width:100%;padding:10px;border:1px solid var(--borda);border-radius:6px;font-size:14px}
        input[readonly]{background:#f1f3f5}
        .small{font-size:12px;color:#666}
        .radio-group-buttons{display:flex;flex-wrap:wrap;gap:8px}
        .radio-button{padding:8px 10px;border:1px solid var(--borda);border-radius:6px;cursor:pointer;font-weight:600;font-size:var(--font-size-sm)}
        .radio-button[aria-checked="true"]{background:var(--azul-marinho);color:var(--dourado);border-color:var(--azul-marinho)}
        .error{color:var(--erro);font-size:var(--font-size-sm);margin-top:6px}
        .info-message{display:none;padding:12px;border-left:4px solid;border-radius:6px;margin-bottom:12px}
        .info-message.success{background:#e8f5e9;color:var(--sucesso);border-left-color:var(--sucesso)}
        .info-message.error{background:#fff0f2;color:var(--erro);border-left-color:var(--erro)}
        .info-message.warning{background:#fff8e1;color:var(--alerta-prazo);border-left-color:var(--alerta-prazo)}
        .actions{display:flex;gap:10px}
        .button{flex:1;padding:12px 14px;border-radius:8px;border:none;background:var(--azul-hover);color:#fff;font-weight:700;cursor:pointer;text-transform:uppercase;transition:background .2s}
        .button.secondary{background:#fff;border:1px solid var(--borda);color:var(--cinza-texto);text-transform:none}
        .button:hover:not(:disabled){background:var(--azul-marinho)}
        .button:disabled{opacity:.6;cursor:not-allowed}
        /* Spinner padr√£o */
        .spinner-base{width:30px;height:30px;border-radius:50%;border:4px solid rgba(0,0,0,.08);border-top:4px solid var(--azul-hover);animation:spin 1s linear infinite}
        #loadingOverlay{position:fixed;top:0;left:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(255,255,255,.85);z-index:9999}
        .spinner-lg{width:36px;height:36px;border-width:5px}
        @keyframes spin{to{transform:rotate(360deg)}}
        .field-with-spinner{position:relative}
        .mini-spinner{position:absolute;right:8px;top:50%;transform:translateY(-50%);width:18px;height:18px;border-radius:50%;border:3px solid rgba(0,0,0,.08);border-top:3px solid var(--azul-hover);animation:spin .8s linear infinite;display:none}
        .is-loading .mini-spinner{display:block}
        .footer{font-size:12px;color:#666;text-align:center;margin-top:8px}
        
        /* Estilos do Modal */
        .modal-base{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);align-items:center;justify-content:center;z-index:9998}
        .modal-content{background:#fff;padding:18px;border-radius:10px;max-width:520px;width:92%;box-shadow:0 5px 15px rgba(0,0,0,.3)}
        .modal-title{margin:0 0 8px 0;color:var(--azul-marinho)}
        .modal-body{font-size:14px;color:#333;margin-bottom:12px}
        .history-list{list-style:none;padding:0;margin-top:10px}
        .history-list li{margin-bottom:5px;padding:5px;border-bottom:1px dashed #eee;font-size:var(--font-size-sm)}

        @media(max-width:640px){.grid{grid-template-columns:1fr}.logos img{height:44px}.container{padding:18px}}
    </style>
</head>
<body>

<div id="loadingOverlay" role="status" aria-live="polite">
    <div style="text-align:center">
        <div class="spinner-base"></div>
        <div style="margin-top:10px;color:var(--azul-marinho)">Enviando...</div>
    </div>
</div>

<div class="container" id="app">
    <div id="progressBarContainer"><div id="progressBar" aria-hidden="true"></div></div>

    <header>
        <div class="logos">
            <img src="https://rondonia.ro.gov.br/wp-content/uploads/2024/09/Brasao-PMRO-370x523.png" alt="Bras√£o PMRO" loading="lazy">
            <img src="https://museu.pm.ro.gov.br/wp-content/uploads/2024/05/1-bpm-3.png" alt="1¬∫ BPM" loading="lazy">
        </div>
        <div style="flex:1">
            <h1>DERSO ‚Äî 1¬∫ BPM</h1>
            <div class="subtitle">Solicita√ß√£o de Di√°ria Especial de Refor√ßo do Servi√ßo Operacional</div>
        </div>
    </header>

    <div id="prazoMessage" class="info-message" role="status" aria-live="polite"></div>

    <div id="initialLoading" style="text-align:center;padding:26px;color:var(--azul-marinho)">
        <div class="spinner-base spinner-lg"></div>
        <div style="margin-top:10px">Carregando dados do sistema...</div>
    </div>

    <form id="dersoForm" style="display:none" aria-labelledby="formTitle">
        <fieldset aria-labelledby="idTitle">
            <legend id="idTitle">Identifica√ß√£o</legend>
            <div class="grid">
                <div>
                    <label for="email">E-mail</label>
                    <input type="email" id="email" name="email" list="emailProviders" autocomplete="email" aria-describedby="emailHelp">
                    <datalist id="emailProviders"></datalist>
                    <div id="emailHelp" class="small">Use seu e-mail institucional ou pessoal.</div>
                </div>
                <div>
                    <label for="matricula">Matr√≠cula</label>
                    <div class="field-with-spinner" id="matBlock">
                        <input type="text" id="matricula" name="matricula" inputmode="numeric" pattern="\d*" required placeholder="Ex: 100012345" aria-describedby="matError">
                        <div class="mini-spinner" id="matSpinner" aria-hidden="true"></div>
                    </div>
                    <div id="matError" class="small error" aria-live="polite"></div>
                </div>
                <div>
                    <label for="nome">Nome</label>
                    <input type="text" id="nome" name="nome" readonly aria-readonly="true">
                </div>
                <div>
                    <label for="data">Data</label>
                    <input type="date" id="data" name="data" required aria-describedby="dateHelp dateError">
                    <div id="dateHelp" class="small"></div>
                    <div id="dateError" class="small error" aria-live="polite"></div>
                </div>
            </div>
        </fieldset>

        <fieldset role="radiogroup" aria-label="Tipo de Folga">
            <legend>Tipo de Folga</legend>
            <div class="radio-group-buttons" id="folgaGroup">
                </div>
            <div id="duplicateError" class="error" aria-live="polite"></div>
        </fieldset>

        <div style="display:flex;gap:10px;align-items:center;margin-top:8px;margin-bottom:6px">
            <button type="button" class="button secondary" id="btnHistory">Ver Hist√≥rico</button>
            <button type="submit" class="button" id="btnSubmit">Enviar Solicita√ß√£o</button>
        </div>

    </form>

    <div id="statusMessage" class="info-message" role="status" aria-live="polite"></div>

    <div class="footer" id="footerText"></div>
</div>

<div id="confirmModal" class="modal-base" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
    <div class="modal-content">
        <h3 id="confirmTitle" class="modal-title">Confirme sua Solicita√ß√£o</h3>
        <div id="summaryBox" class="modal-body"></div>
        <div style="display:flex;gap:8px">
            <button id="confirmSend" class="button">Confirmar e Enviar</button>
            <button id="cancelSend" class="button secondary">Voltar</button>
        </div>
    </div>
</div>

<div id="historyModal" class="modal-base" role="dialog" aria-modal="true" aria-labelledby="historyTitle">
    <div class="modal-content">
        <h3 id="historyTitle" class="modal-title">Hist√≥rico de Solicita√ß√µes</h3>
        <div id="historyBox" class="modal-body"></div>
        <div style="display:flex;justify-content:flex-end">
            <button id="closeHistory" class="button secondary">Fechar</button>
        </div>
    </div>
</div>

<script>
    // ***********************************************
    // AQUI EST√Å A NOVA URL ATUALIZADA:
    // ***********************************************
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwJSs4qbK_j85gh-z12D6kcqJKE2DbQWitTvvnScUEv5DswRJXkF4X5cQW4ViwK8D6Yzg/exec"; 
    const emailProviders = ["gmail.com","hotmail.com","outlook.com","yahoo.com","terra.com.br","bol.com.br","pm.ro.gov.br"];

    // estado global
    window.employeeList = {};
    const DERSO = {
        minDate: null,
        maxDate: null,
        emailInput: document.getElementById('email'),
        matriculaInput: document.getElementById('matricula'),
        nomeInput: document.getElementById('nome'),
        dataInput: document.getElementById('data'),
        dateErrorEl: document.getElementById('dateError'),
        folgaGroup: document.getElementById('folgaGroup'),
        duplicateErrorEl: document.getElementById('duplicateError'),
        statusMessageEl: document.getElementById('statusMessage'),
        prazoMessageEl: document.getElementById('prazoMessage'),
        loadingOverlay: document.getElementById('loadingOverlay'),
        matBlock: document.getElementById('matBlock'),
        formEl: document.getElementById('dersoForm'),
        matErrorEl: document.getElementById('matError'),
        btnSubmit: document.getElementById('btnSubmit'),
        progressBar: document.getElementById('progressBar')
    };

    function setProgress(p){ DERSO.progressBar.style.width = p + '%'; }

    // fetch com timeout e retries
    async function fetchWithTimeout(url, opts = {}, timeout = 8000){
        const controller = new AbortController();
        const id = setTimeout(()=>controller.abort(), timeout);
        try{
            const res = await fetch(url, {...opts, signal: controller.signal});
            clearTimeout(id);
            return res;
        }catch(e){ clearTimeout(id); throw e; }
    }

    // debounce helper
    function debounce(fn, wait){ let t; return function(...a){ clearTimeout(t); t = setTimeout(()=>fn.apply(this,a), wait); }; }

    function setDateLimits(abertura, fechamento){
        const dateInput = DERSO.dataInput;
        const dateHelp = document.getElementById('dateHelp');
        // Fallback de datas: primeiro dia do pr√≥ximo m√™s
        const today = new Date();
        const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);
        
        DERSO.minDate = abertura ? new Date(abertura) : nextMonth;
        DERSO.maxDate = fechamento ? new Date(fechamento) : new Date(nextMonth.getFullYear(), nextMonth.getMonth()+1, 0); // √öltimo dia do pr√≥ximo m√™s

        dateInput.min = DERSO.minDate.toISOString().split('T')[0];
        dateInput.max = DERSO.maxDate.toISOString().split('T')[0];
        
        const formatter = new Intl.DateTimeFormat('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        dateHelp.textContent = `Per√≠odo permitido: ${formatter.format(DERSO.minDate)} ‚Äî ${formatter.format(DERSO.maxDate)}`;
    }

    function standardizeMatricula(m){
        if(!m) return '';
        let num = m.replace(/\D/g,'').slice(-9);
        if(!num) return '';
        return num.startsWith('1000') ? num : '1000' + num.slice(-5);
    }

    const folgas = ['24H','48H','72H','96H','FOLGA LE','1¬™ FOLGA','2¬™ FOLGA','EXPEDIENTE'];
    function renderFolgas(){
        const g = DERSO.folgaGroup;
        g.innerHTML = '';
        folgas.forEach((f)=>{
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'radio-button';
            btn.setAttribute('role','radio');
            btn.setAttribute('aria-checked','false');
            btn.textContent = f;
            btn.dataset.value = f;
            btn.addEventListener('click', ()=>{
                [...g.querySelectorAll('[role="radio"]')].forEach(b=>b.setAttribute('aria-checked','false'));
                btn.setAttribute('aria-checked','true');
            });
            g.appendChild(btn);
        });
    }

    function updateEmailDatalist(){
        const input = DERSO.emailInput;
        const dl = document.getElementById('emailProviders');
        const val = input.value || '';
        const idx = val.indexOf('@');
        dl.innerHTML = '';
        let username = (idx >= 0) ? val.slice(0, idx+1) : val;
        
        const fragment = document.createDocumentFragment();
        emailProviders.forEach(d => {
            if(!val || idx === -1 || d.startsWith(val.slice(idx+1).toLowerCase())){
                const option = document.createElement('option');
                option.value = username + d;
                fragment.appendChild(option);
            }
        });
        dl.appendChild(fragment);
    }

    async function loadEmployeeList(){
        setProgress(10);
        DERSO.matriculaInput.disabled = true;
        DERSO.matErrorEl.textContent = '';
        try{
            const res = await fetchWithTimeout(SCRIPT_URL+'?action=lista', {}, 9000);
            const data = await res.json();
            if(data.error) throw new Error(data.error);
            window.employeeList = data;
            DERSO.matriculaInput.disabled = false;
            setProgress(30);
        }catch(e){
            DERSO.matErrorEl.textContent = 'Erro ao carregar lista de funcion√°rios.';
            showPersistentMessage('‚ö†Ô∏è Erro ao carregar dados do Efetivo. Recarregue a p√°gina ou contate o suporte.','error');
            document.getElementById('initialLoading').style.display = 'none';
            DERSO.formEl.style.display = 'none';
            console.error(e);
        }
    }

    async function checkMatricula(){
        const m = DERSO.matriculaInput;
        const n = DERSO.nomeInput;
        const e = DERSO.matErrorEl;
        e.textContent = '';
        n.value = '';
        m.classList.remove('is-invalid', 'is-valid');

        const raw = m.value.trim();
        if(!raw) { return; }
        const standardized = standardizeMatricula(raw);
        if(!standardized){ e.textContent = 'Matr√≠cula inv√°lida.'; m.classList.add('is-invalid'); return; }
        m.value = standardized;

        DERSO.matBlock.classList.add('is-loading');

        // Lookup local
        if(window.employeeList && window.employeeList[standardized]){
            n.value = window.employeeList[standardized];
            m.classList.add('is-valid');
            DERSO.matBlock.classList.remove('is-loading');
            return;
        }

        // Fallback remoto
        try{
            // O Apps Script agora tem um action=lookup para isso.
            const res = await fetchWithTimeout(SCRIPT_URL+`?action=lookup&matricula=${standardized}`,{},7000);
            const d = await res.json();
            if(d && d.nome){
                n.value = d.nome;
                m.classList.add('is-valid');
            } else {
                e.textContent = 'Matr√≠cula n√£o encontrada.';
                m.classList.add('is-invalid');
            }
        }catch(err){
            console.warn('lookup falhou',err);
            e.textContent = 'Erro ao validar matr√≠cula. Tente novamente.';
            m.classList.add('is-invalid');
        }finally{
            DERSO.matBlock.classList.remove('is-loading');
        }
    }

    const debouncedCheckMatricula = debounce(checkMatricula, 350);

    async function checkDuplicity(matricula, dataBR, folga){
        setProgress(70);
        try{
            const url = `${SCRIPT_URL}?action=check_duplicidade&matricula=${encodeURIComponent(matricula)}&data=${encodeURIComponent(dataBR)}&folga=${encodeURIComponent(folga)}`;
            const res = await fetchWithTimeout(url,{},7000);
            const j = await res.json();
            return j.duplicado === true;
        }catch(e){
            console.error('Falha duplicidade',e);
            showMessage('‚ö†Ô∏è N√£o foi poss√≠vel verificar duplicidade. Tentando prosseguir...','error');
            return false;
        }
    }

    function validateForm(){
        DERSO.matErrorEl.textContent = '';
        DERSO.dateErrorEl.textContent = '';
        DERSO.duplicateErrorEl.textContent = '';

        const nomeVal = DERSO.nomeInput.value.trim();
        const dataVal = DERSO.dataInput.value;
        const folgaBtn = document.querySelector('#folgaGroup [aria-checked="true"]');
        const matriculaInvalid = DERSO.matriculaInput.classList.contains('is-invalid') || !DERSO.matriculaInput.value.trim();

        let valid = true;

        if(!folgaBtn){
            DERSO.duplicateErrorEl.textContent = 'Selecione um tipo de folga.';
            valid = false;
        }
        if(!nomeVal || matriculaInvalid){
            DERSO.matErrorEl.textContent = 'Verifique a matr√≠cula.';
            valid = false;
        }
        if(!dataVal || new Date(dataVal) < DERSO.minDate || new Date(dataVal) > DERSO.maxDate){
             DERSO.dateErrorEl.textContent = 'Escolha uma data v√°lida dentro do per√≠odo permitido.';
             valid = false;
        }

        return valid;
    }

    async function submitForm(e){
        e.preventDefault();
        
        if(!validateForm()) { return; }

        const folgaBtn = document.querySelector('#folgaGroup [aria-checked="true"]');
        
        const summary = {
            matricula: DERSO.matriculaInput.value,
            nome: DERSO.nomeInput.value.trim(),
            email: DERSO.emailInput.value.trim(),
            data: formatBR(DERSO.dataInput.value),
            folga: folgaBtn.dataset.value
        };
        showConfirmationModal(summary);
    }

    async function confirmAndSend(summary){
        DERSO.btnSubmit.disabled = true; // Previne duplo clique

        try{
            document.getElementById('confirmModal').style.display = 'none';
            DERSO.loadingOverlay.style.display = 'flex';
            setProgress(80);

            const isDup = await checkDuplicity(summary.matricula, summary.data, summary.folga);
            if(isDup){ 
                showMessage(`‚ö†Ô∏è Solicita√ß√£o DUPLICADA para ${summary.data} ‚Äî ${summary.folga}. O envio foi cancelado. Voc√™ pode verificar no Hist√≥rico.`,'error'); 
                return; 
            }

            const payload = new URLSearchParams();
            payload.set('matricula', summary.matricula);
            payload.set('nome', summary.nome);
            payload.set('email', summary.email);
            payload.set('data', summary.data);
            payload.set('folga', summary.folga);

            const res = await fetchWithTimeout(SCRIPT_URL, {method:'POST', body: payload}, 10000);
            const j = await res.json();
            
            if(j && j.success){
                showMessage('‚úÖ Solicita√ß√£o enviada com sucesso. Verifique seu e-mail.','success');
                // Limpar apenas em caso de sucesso
                const currentEmail = DERSO.emailInput.value;
                DERSO.formEl.reset();
                DERSO.nomeInput.value = '';
                DERSO.emailInput.value = currentEmail; // Mant√©m o email preenchido
                DERSO.matriculaInput.classList.remove('is-valid');
                document.querySelector('#folgaGroup [aria-checked="true"]').setAttribute('aria-checked','false');
                
                // Salvar √∫ltimo uso
                try{ localStorage.setItem('derso_lastEmail', summary.email || ''); }catch(e){}

            } else {
                showMessage('‚ö†Ô∏è Erro ao enviar: '+(j.error || 'Tente novamente.'),'error');
            }
        }catch(e){
            console.error(e);
            showMessage('‚ö†Ô∏è Falha na conex√£o. Tente novamente.','error');
        }finally{
            DERSO.loadingOverlay.style.display = 'none';
            DERSO.btnSubmit.disabled = false;
            setProgress(100);
            setTimeout(()=>setProgress(0),1200);
        }
    }

    // Auxiliares
    function formatBR(iso){ if(!iso) return ''; const [y,m,d] = iso.split('-'); return `${d}/${m}/${y}`; }

    function showMessage(msg,type='success'){
        const d = DERSO.statusMessageEl; 
        d.className = 'info-message '+(type==='success'?'success':'error'); 
        d.innerHTML = msg; 
        d.style.display = 'block';
        setTimeout(()=>{ d.style.display = 'none'; },6000);
    }

    function showPersistentMessage(msg,type='success'){ 
        DERSO.prazoMessageEl.className = 'info-message '+(type); 
        DERSO.prazoMessageEl.innerHTML = msg; 
        DERSO.prazoMessageEl.style.display = 'block'; 
    }

    // Modal de Confirma√ß√£o (Envio)
    function showConfirmationModal(summary){
        const box = document.getElementById('summaryBox');
        box.innerHTML = `<div><strong>Nome:</strong> ${summary.nome}</div><div><strong>Matr√≠cula:</strong> ${summary.matricula}</div><div><strong>Folga:</strong> ${summary.folga}</div><div><strong>Data:</strong> ${summary.data}</div><div style="margin-top:8px;font-size:13px;color:#666">E-mail: ${summary.email||'---'}</div>`;
        const modal = document.getElementById('confirmModal'); 
        modal.style.display = 'flex';
        document.getElementById('confirmSend').onclick = ()=>confirmAndSend(summary);
        document.getElementById('cancelSend').onclick = ()=>modal.style.display = 'none';
        document.getElementById('confirmSend').focus(); // Foco para acessibilidade
    }

    // Modal de Hist√≥rico
    async function showHistoryModal(){
        const matricula = DERSO.matriculaInput.value.trim();
        if(!matricula || DERSO.matriculaInput.classList.contains('is-invalid')){
            showMessage("Digite e valide a matr√≠cula para ver o hist√≥rico.", "error");
            return;
        }

        const modal = document.getElementById('historyModal');
        const box = document.getElementById('historyBox');
        
        box.innerHTML = '<div style="text-align:center"><div class="spinner-base" style="width:20px;height:20px;border-width:3px"></div></div>';
        modal.style.display = 'flex';

        try {
            const resp = await fetchWithTimeout(`${SCRIPT_URL}?matricula=${encodeURIComponent(matricula)}&action=historico`, {}, 8000);
            const dados = await resp.json();

            // A requisi√ß√£o falhou antes de receber o JSON
            if(!dados){ throw new Error('Resposta vazia do servidor.'); }

            if(dados.error){
                 box.innerHTML = `<p style="color:var(--erro)">Erro ao buscar hist√≥rico: ${dados.error || 'Falha na comunica√ß√£o.'}</p>`;
                 return;
            }

            let html = `<div>Hist√≥rico de solicita√ß√µes para <strong>Matr√≠cula ${matricula}</strong>:</div>`;

            if(dados.length === 0){
                html += `<p style="color:#666;font-style:italic;margin-top:10px">Nenhuma solicita√ß√£o encontrada no per√≠odo aberto.</p>`;
            } else {
                html += `<ul class="history-list">`;
                // Os dados v√™m do Apps Script como: {Data, Folga, Status}
                dados.slice(0, 10).forEach(item => { // Limitar a 10 itens
                    const statusText = item.Status;
                    let statusColor;
                    let icon;

                    if (statusText === 'APROVADA') {
                        statusColor = 'var(--sucesso)';
                        icon = '‚úÖ Aprovada';
                    } else if (statusText === 'RECUSADA') {
                        statusColor = 'var(--erro)';
                        icon = '‚ùå Recusada';
                    } else {
                         statusColor = 'var(--alerta-prazo)';
                        icon = '‚è≥ Aguardando';
                    }

                    html += `<li>
                                <strong>${item.Data}</strong> ‚Äî ${item.Folga}
                                (<span style="color:${statusColor}; font-weight: 500;">${icon}</span>)
                            </li>`;
                });
                html += `</ul>`;
                html += `<div class="small" style="margin-top:10px">Exibindo as √∫ltimas ${dados.length > 10 ? 10 : dados.length} solicita√ß√µes.</div>`;
            }

            box.innerHTML = html;

        } catch(e){
            console.error('Erro ao buscar hist√≥rico:', e);
            box.innerHTML = `<p style="color:var(--erro)">Erro de conex√£o ou timeout ao buscar hist√≥rico. Verifique a matr√≠cula e tente novamente.</p>`;
        }
        document.getElementById('closeHistory').focus();
    }

    async function initializeForm(){
        setProgress(5);
        renderFolgas();
        updateEmailDatalist();
        
        // 1. Carrega a lista de efetivo
        await loadEmployeeList();
        setProgress(40);

        // 2. Verifica per√≠odo aberto (datas fornecidas pelo script)
        try{
            const res = await fetchWithTimeout(SCRIPT_URL+'?action=datas',{},7000);
            const d = await res.json();
            
            if(d.error){ throw new Error(d.error); }
            
            const now = new Date();
            // As datas v√™m no formato ISO
            const abertura = new Date(d.abertura);
            const fechamento = new Date(d.fechamento);

            setDateLimits(abertura, fechamento); // Define limites
            document.getElementById('initialLoading').style.display = 'none';
            
            let message = '';
            let type = 'success';
            
            if(now < abertura){
                message = `‚è≥ Abertura para solicita√ß√µes em ${abertura.toLocaleString('pt-BR')}`;
                type = 'error';
                DERSO.formEl.style.display = 'none';
            }
            else if(now > fechamento){
                message = `‚õî Per√≠odo de solicita√ß√µes encerrado em ${fechamento.toLocaleString('pt-BR')}`;
                type = 'error';
                DERSO.formEl.style.display = 'none';
            }
            else{ // aberto
                DERSO.formEl.style.display = 'block';
                const diffMs = fechamento - now;
                // C√°lculo de dias exato (ajustado para horas)
                const diffDays = Math.floor(diffMs/(1000*60*60*24));
                const diffHours = Math.ceil((diffMs % (1000*60*60*24)) / (1000*60*60));
                
                const timeRemaining = `${diffDays} dia(s) e ${diffHours} hora(s)`;

                if(diffDays <= 3) type = 'warning'; // Alerta se faltar 3 dias ou menos

                message = `üö® **PRAZO:** Restam ${timeRemaining} ‚Äî fechamento: ${fechamento.toLocaleString('pt-BR')}`;
            }
            showPersistentMessage(message, type);

        }catch(err){
            console.warn("Erro ao carregar datas do servidor:", err);
            // Se falhar, usa o fallback de datas para o pr√≥ximo m√™s
            setDateLimits(); 
            document.getElementById('initialLoading').style.display = 'none';
            DERSO.formEl.style.display = 'block';
            showPersistentMessage('‚ö†Ô∏è Falha ao obter prazo. O formul√°rio est√° aberto, mas verifique se o Apps Script est√° ativo e as datas configuradas.','error');
        }

        // Tenta restaurar √∫ltimo e-mail usado
        try{ 
            const lastEmail = localStorage.getItem('derso_lastEmail'); 
            if(lastEmail) DERSO.emailInput.value = lastEmail; 
        }catch(e){}

        const now = new Date(); 
        const mes = String(now.getMonth()+1).padStart(2,'0'); 
        const ano = now.getFullYear();
        document.getElementById('footerText').textContent = `Desenvolvido na 1¬™ Cia do 1¬∫ BPM ‚Äî PVSA Pedro Porto ‚Äî ${mes}/${ano}`;
        setProgress(60);
    }

    // Listeners
    document.addEventListener('DOMContentLoaded', ()=>{
        initializeForm();
        DERSO.matriculaInput.addEventListener('input', debouncedCheckMatricula);
        DERSO.emailInput.addEventListener('input', updateEmailDatalist);
        DERSO.formEl.addEventListener('submit', submitForm);
        document.getElementById('btnHistory').addEventListener('click', showHistoryModal);
        document.getElementById('closeHistory').addEventListener('click', ()=>document.getElementById('historyModal').style.display = 'none');

        // Impede submit por Enter em inputs
        document.addEventListener('keydown', (e)=>{
            if(e.key === 'Enter' && e.target && (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT')){
                e.preventDefault();
            }
        });
    });

</script>
</body>
</html>
